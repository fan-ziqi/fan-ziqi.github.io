<!DOCTYPE html><html lang="zh-CN" data-theme="light"><head><meta charset="UTF-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="viewport" content="width=device-width, initial-scale=1.0,viewport-fit=cover"><title>四足机器人传统控制方法学习笔记 | 范子琦的博客</title><meta name="author" content="Fan Ziqi"><meta name="copyright" content="Fan Ziqi"><meta name="format-detection" content="telephone=no"><meta name="theme-color" content="#ffffff"><meta name="description" content="四足机器人传统控制方法学习笔记运动学与动力学单腿运动学正运动学目标：已知三个关节的角度 $(\theta_1,\theta_2,\theta_3)$ ，需要求出足端位置 $(x,y,z)$   \begin{aligned}  \boldsymbol{T}_{01}&amp;&#x3D; \begin{bmatrix} \mathrm{rot}_x(\theta_1) &amp; \boldsymbol{0}_{3\tim">
<meta property="og:type" content="article">
<meta property="og:title" content="四足机器人传统控制方法学习笔记">
<meta property="og:url" content="https://www.robotsfan.com/posts/311d50f4.html">
<meta property="og:site_name" content="范子琦的博客">
<meta property="og:description" content="四足机器人传统控制方法学习笔记运动学与动力学单腿运动学正运动学目标：已知三个关节的角度 $(\theta_1,\theta_2,\theta_3)$ ，需要求出足端位置 $(x,y,z)$   \begin{aligned}  \boldsymbol{T}_{01}&amp;&#x3D; \begin{bmatrix} \mathrm{rot}_x(\theta_1) &amp; \boldsymbol{0}_{3\tim">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://fan-ziqi.oss-cn-beijing.aliyuncs.com/img/blog-cover3.jpg">
<meta property="article:published_time" content="2024-06-09T03:30:00.000Z">
<meta property="article:modified_time" content="2024-07-17T03:05:25.848Z">
<meta property="article:author" content="Fan Ziqi">
<meta property="article:tag" content="机器人">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="https://fan-ziqi.oss-cn-beijing.aliyuncs.com/img/blog-cover3.jpg"><link rel="shortcut icon" href="https://fan-ziqi.oss-cn-beijing.aliyuncs.com/img/blog-favicon.png"><link rel="canonical" href="https://www.robotsfan.com/posts/311d50f4.html"><link rel="preconnect" href="//cdn.jsdelivr.net"/><link rel="preconnect" href="//fonts.googleapis.com" crossorigin=""/><link rel="preconnect" href="//busuanzi.ibruce.info"/><link rel="stylesheet" href="/css/index.css"><link rel="stylesheet" href="https://unpkg.com/@fortawesome/fontawesome-free/css/all.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://unpkg.com/node-snackbar/dist/snackbar.min.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://unpkg.com/@fancyapps/ui/dist/fancybox/fancybox.css" media="print" onload="this.media='all'"><link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Titillium+Web&amp;display=swap" media="print" onload="this.media='all'"><script>const GLOBAL_CONFIG = {
  root: '/',
  algolia: undefined,
  localSearch: {"path":"/search.xml","preload":false,"top_n_per_article":1,"unescape":false,"languages":{"hits_empty":"找不到您查询的内容：${query}","hits_stats":"共找到 ${hits} 篇文章"}},
  translate: {"defaultEncoding":2,"translateDelay":0,"msgToTraditionalChinese":"繁","msgToSimplifiedChinese":"簡"},
  noticeOutdate: undefined,
  highlight: {"plugin":"highlighjs","highlightCopy":true,"highlightLang":true,"highlightHeightLimit":false},
  copy: {
    success: '复制成功',
    error: '复制错误',
    noSupport: '浏览器不支持'
  },
  relativeDate: {
    homepage: false,
    post: false
  },
  runtime: '天',
  dateSuffix: {
    just: '刚刚',
    min: '分钟前',
    hour: '小时前',
    day: '天前',
    month: '个月前'
  },
  copyright: undefined,
  lightbox: 'fancybox',
  Snackbar: {"chs_to_cht":"你已切换为繁体","cht_to_chs":"你已切换为简体","day_to_night":"你已切换为深色模式","night_to_day":"你已切换为浅色模式","bgLight":"#49b1f5","bgDark":"#121212","position":"top-center"},
  source: {
    justifiedGallery: {
      js: 'https://unpkg.com/flickr-justified-gallery/dist/fjGallery.min.js',
      css: 'https://unpkg.com/flickr-justified-gallery/dist/fjGallery.css'
    }
  },
  isPhotoFigcaption: false,
  islazyload: true,
  isAnchor: false,
  percent: {
    toc: true,
    rightside: false,
  },
  autoDarkmode: false
}</script><script id="config-diff">var GLOBAL_CONFIG_SITE = {
  title: '四足机器人传统控制方法学习笔记',
  isPost: true,
  isHome: false,
  isHighlightShrink: false,
  isToc: true,
  postUpdate: '2024-07-17 11:05:25'
}</script><noscript><style type="text/css">
  #nav {
    opacity: 1
  }
  .justified-gallery img {
    opacity: 1
  }

  #recent-posts time,
  #post-meta time {
    display: inline !important
  }
</style></noscript><script>(win=>{
    win.saveToLocal = {
      set: function setWithExpiry(key, value, ttl) {
        if (ttl === 0) return
        const now = new Date()
        const expiryDay = ttl * 86400000
        const item = {
          value: value,
          expiry: now.getTime() + expiryDay,
        }
        localStorage.setItem(key, JSON.stringify(item))
      },

      get: function getWithExpiry(key) {
        const itemStr = localStorage.getItem(key)

        if (!itemStr) {
          return undefined
        }
        const item = JSON.parse(itemStr)
        const now = new Date()

        if (now.getTime() > item.expiry) {
          localStorage.removeItem(key)
          return undefined
        }
        return item.value
      }
    }
  
    win.getScript = url => new Promise((resolve, reject) => {
      const script = document.createElement('script')
      script.src = url
      script.async = true
      script.onerror = reject
      script.onload = script.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        script.onload = script.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(script)
    })
  
    win.getCSS = (url,id = false) => new Promise((resolve, reject) => {
      const link = document.createElement('link')
      link.rel = 'stylesheet'
      link.href = url
      if (id) link.id = id
      link.onerror = reject
      link.onload = link.onreadystatechange = function() {
        const loadState = this.readyState
        if (loadState && loadState !== 'loaded' && loadState !== 'complete') return
        link.onload = link.onreadystatechange = null
        resolve()
      }
      document.head.appendChild(link)
    })
  
      win.activateDarkMode = function () {
        document.documentElement.setAttribute('data-theme', 'dark')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#0d0d0d')
        }
      }
      win.activateLightMode = function () {
        document.documentElement.setAttribute('data-theme', 'light')
        if (document.querySelector('meta[name="theme-color"]') !== null) {
          document.querySelector('meta[name="theme-color"]').setAttribute('content', '#ffffff')
        }
      }
      const t = saveToLocal.get('theme')
    
          if (t === 'dark') activateDarkMode()
          else if (t === 'light') activateLightMode()
        
      const asideStatus = saveToLocal.get('aside-status')
      if (asideStatus !== undefined) {
        if (asideStatus === 'hide') {
          document.documentElement.classList.add('hide-aside')
        } else {
          document.documentElement.classList.remove('hide-aside')
        }
      }
    
    const detectApple = () => {
      if(/iPad|iPhone|iPod|Macintosh/.test(navigator.userAgent)){
        document.documentElement.classList.add('apple')
      }
    }
    detectApple()
    })(window)</script><!-- Matomo --><script>var _paq=window._paq=window._paq||[];_paq.push(["setDocumentTitle",document.domain+"/"+document.title]);_paq.push(['trackPageView']);_paq.push(['enableLinkTracking']);(function(){var u="//matomo.robotsfan.com/";_paq.push(['setTrackerUrl',u+'matomo.php']);_paq.push(['setSiteId','4']);var d=document,g=d.createElement('script'),s=d.getElementsByTagName('script')[0];g.async=!0;g.src=u+'matomo.js';s.parentNode.insertBefore(g,s)})();</script><!-- End Matomo Code --><meta name="generator" content="Hexo 5.4.2"><link rel="alternate" href="/atom.xml" title="范子琦的博客" type="application/atom+xml">
</head><body><div id="web_bg"></div><div id="sidebar"><div id="menu-mask"></div><div id="sidebar-menus"><div class="avatar-img is-center"><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://fan-ziqi.oss-cn-beijing.aliyuncs.com/img/blog-avatar.png" onerror="onerror=null;src='https://fan-ziqi.oss-cn-beijing.aliyuncs.com/img/blog-friend_404.gif'" alt="avatar"/></div><div class="sidebar-site-data site-data is-center"><a href="/archives/"><div class="headline">文章</div><div class="length-num">61</div></a><a href="/tags/"><div class="headline">标签</div><div class="length-num">20</div></a><a href="/categories/"><div class="headline">分类</div><div class="length-num">12</div></a></div><hr class="custom-hr"/><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> 文章合集</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/CPP/"><i class="fa-fw fas fa-link"></i><span> 深入学习C++</span></a></li><li><a class="site-page child" href="/Robotics/"><i class="fa-fw fas fa-link"></i><span> 机器人学</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/cv/"><i class="fa-fw fa fa-address-card"></i><span> 简历</span></a></div></div></div></div><div class="post" id="body-wrap"><header class="post-bg" id="page-header" style="background-image: url('https://fan-ziqi.oss-cn-beijing.aliyuncs.com/img/blog-cover3.jpg')"><nav id="nav"><span id="blog-info"><a href="/" title="范子琦的博客"><span class="site-name">范子琦的博客</span></a></span><div id="menus"><div id="search-button"><a class="site-page social-icon search" href="javascript:void(0);"><i class="fas fa-search fa-fw"></i><span> 搜索</span></a></div><div class="menus_items"><div class="menus_item"><a class="site-page" href="/"><i class="fa-fw fas fa-home"></i><span> 首页</span></a></div><div class="menus_item"><a class="site-page" href="/archives/"><i class="fa-fw fas fa-archive"></i><span> 时间轴</span></a></div><div class="menus_item"><a class="site-page" href="/categories/"><i class="fa-fw fas fa-folder-open"></i><span> 分类</span></a></div><div class="menus_item"><a class="site-page group" href="javascript:void(0);"><i class="fa-fw fas fa-book"></i><span> 文章合集</span><i class="fas fa-chevron-down"></i></a><ul class="menus_item_child"><li><a class="site-page child" href="/CPP/"><i class="fa-fw fas fa-link"></i><span> 深入学习C++</span></a></li><li><a class="site-page child" href="/Robotics/"><i class="fa-fw fas fa-link"></i><span> 机器人学</span></a></li></ul></div><div class="menus_item"><a class="site-page" href="/messageboard/"><i class="fa-fw fa fa-paper-plane"></i><span> 留言板</span></a></div><div class="menus_item"><a class="site-page" href="/cv/"><i class="fa-fw fa fa-address-card"></i><span> 简历</span></a></div></div><div id="toggle-menu"><a class="site-page" href="javascript:void(0);"><i class="fas fa-bars fa-fw"></i></a></div></div></nav><div id="post-info"><h1 class="post-title">四足机器人传统控制方法学习笔记</h1><div id="post-meta"><div class="meta-firstline"><span class="post-meta-date"><i class="far fa-calendar-alt fa-fw post-meta-icon"></i><span class="post-meta-label">发表于</span><time class="post-meta-date-created" datetime="2024-06-09T03:30:00.000Z" title="发表于 2024-06-09 11:30:00">2024-06-09</time><span class="post-meta-separator">|</span><i class="fas fa-history fa-fw post-meta-icon"></i><span class="post-meta-label">更新于</span><time class="post-meta-date-updated" datetime="2024-07-17T03:05:25.848Z" title="更新于 2024-07-17 11:05:25">2024-07-17</time></span><span class="post-meta-categories"><span class="post-meta-separator">|</span><i class="fas fa-inbox fa-fw post-meta-icon"></i><a class="post-meta-categories" href="/categories/%E7%AE%97%E6%B3%95/">算法</a></span></div><div class="meta-secondline"><span class="post-meta-separator">|</span><span class="post-meta-wordcount"><i class="far fa-file-word fa-fw post-meta-icon"></i><span class="post-meta-label">字数总计:</span><span class="word-count">13.4k</span><span class="post-meta-separator">|</span><i class="far fa-clock fa-fw post-meta-icon"></i><span class="post-meta-label">阅读时长:</span><span>65分钟</span></span><span class="post-meta-separator">|</span><span class="post-meta-pv-cv" id="" data-flag-title="四足机器人传统控制方法学习笔记"><i class="far fa-eye fa-fw post-meta-icon"></i><span class="post-meta-label">阅读量:</span><span id="busuanzi_value_page_pv"><i class="fa-solid fa-spinner fa-spin"></i></span></span></div></div></div></header><main class="layout" id="content-inner"><div id="post"><article class="post-content" id="article-container"><h1 id="四足机器人传统控制方法学习笔记"><a href="#四足机器人传统控制方法学习笔记" class="headerlink" title="四足机器人传统控制方法学习笔记"></a>四足机器人传统控制方法学习笔记</h1><h2 id="运动学与动力学"><a href="#运动学与动力学" class="headerlink" title="运动学与动力学"></a>运动学与动力学</h2><h3 id="单腿运动学"><a href="#单腿运动学" class="headerlink" title="单腿运动学"></a>单腿运动学</h3><h4 id="正运动学"><a href="#正运动学" class="headerlink" title="正运动学"></a>正运动学</h4><p>目标：已知三个关节的角度 $(\theta_1,\theta_2,\theta_3)$ ，需要求出足端位置 $(x,y,z)$ </p>
<script type="math/tex; mode=display">
\begin{aligned}

\boldsymbol{T}_{01}&=
\begin{bmatrix}
\mathrm{rot}_x(\theta_1) & \boldsymbol{0}_{3\times1} \\
\boldsymbol{0}_{3\times3} & 1
\end{bmatrix}=
\begin{bmatrix}
1 & 0 & 0 & 0 \\
0 & \cos(\theta_1) & -\sin(\theta_1) & 0 \\
0 & \sin(\theta_1) & \cos(\theta_1) & 0 \\
0 & 0 & 0 & 1
\end{bmatrix}\\

\boldsymbol{T}_{12}&=
\begin{bmatrix}
\mathrm{rot}_y(\theta_2) & \boldsymbol{0}_{3\times1} \\
\boldsymbol{0}_{3\times3} & 1
\end{bmatrix}=
\begin{bmatrix}
\cos(\theta_2) & 0 & \sin(\theta_2) & 0 \\
0 & 1 & 0 & 0 \\
-\sin(\theta_2) & 0 & \cos(\theta_2) & 0 \\
0 & 0 & 0 & 1
\end{bmatrix}\\

\boldsymbol{T}_{23}&=
\begin{bmatrix}
\mathrm{rot}_y(\theta_3) & \left[\begin{matrix}0\\l_1\\l_2\end{matrix}\right] \\
\boldsymbol{0}_{3\times3} & 1
\end{bmatrix}=
\begin{bmatrix}
\cos(\theta_3) & 0 & \sin(\theta_3) & 0 \\
0 & 1 & 0 & l_1 \\
-\sin(\theta_3) & 0 & \cos(\theta_3) & l_2 \\
0 & 0 & 0 & 1
\end{bmatrix} \quad \begin{aligned} l_1 &= \left\{ \begin{aligned}-l_{abad}&,\text{right}\\l_{abad}&,\text{left}\end{aligned}\right. \\ l_2 &= -l_{hip}\end{aligned}\\

\boldsymbol{p}_3 &= \begin{bmatrix}0\\0\\l_3\\1\end{bmatrix} \quad \begin{aligned}l_3=-l_{knee}\end{aligned}

\end{aligned}</script><p>根据以上变换即可求出足端位置：</p>
<script type="math/tex; mode=display">
\begin{bmatrix}
x_p\\y_p\\z_p\\1
\end{bmatrix}=
\begin{bmatrix}
l_3\sin(\theta_1+\theta_2)+l_2\sin(\theta_2)\\
-l_3\sin(\theta_1)\cos(\theta_2+\theta_3)+l_1\cos(\theta_1)-l_2\cos(\theta_2)\sin(\theta_1)\\
l_3\cos(\theta_1)\cos(\theta_2+\theta_3)+l_1\sin(\theta_1)+l_2\cos(\theta_1)\cos(\theta_2)\\
1
\end{bmatrix}
\tag{1}</script><h4 id="逆运动学"><a href="#逆运动学" class="headerlink" title="逆运动学"></a>逆运动学</h4><p>目标：已知足端位置 $(x,y,z)$ ，需要求出三个关节的角度 $(\theta_1,\theta_2,\theta_3)$ </p>
<ol>
<li><p>求 $\theta_1$ </p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://fan-ziqi.oss-cn-beijing.aliyuncs.com/img/image-20230831154919239.png" alt="image-20230831154919239" style="zoom:50%;"></p>
<script type="math/tex; mode=display">
\begin{aligned}
\boldsymbol{P}_0 &= \boldsymbol{R}_{01} \boldsymbol{P}_1\\
\begin{bmatrix}
y_p\\z_p
\end{bmatrix}&=
\begin{bmatrix}
\cos(\theta_1)&-\sin(\theta_1)\\
\sin(\theta_1)&\cos(\theta_1)
\end{bmatrix}
\begin{bmatrix}
L\\-L
\end{bmatrix}
\end{aligned}</script><p>整理得</p>
<script type="math/tex; mode=display">
\left\{
\begin{aligned}
y_p&=l_1\cos(\theta_1)+L\sin(\theta_1)\\
z_p&=l_1\sin(\theta_1)-L\cos(\theta_1)
\end{aligned}
\right.\Rightarrow
\left\{
\begin{aligned}
\frac{y_p}{\cos(\theta_1)}=l_1+L\tan(\theta_1)\\
\frac{z_p}{\cos(\theta_1)}=l_1\tan(\theta_1)-L
\end{aligned}
\right.</script><p>由于 $z_p \ne 0$ ，可以推出 $\frac{y_p}{z_p}=\frac{l_1+L\tan(\theta_1)}{l_1\tan(\theta_1)-L}$ ，从而可以解出 $\tan(\theta_1)=\frac{z_pl_1+y_pL}{y_pl_1-z_pL}$ ，即 $\theta_1=\arctan\left(\frac{z_pl_1+y_pL}{y_pl_1-z_pL}\right)$ </p>
</li>
<li><p>求 $\theta_3$ （余弦定理）</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://fan-ziqi.oss-cn-beijing.aliyuncs.com/img/image-20230831154952123.png" alt="image-20230831154952123" style="zoom:50%;"></p>
<p>从图中可以得</p>
<script type="math/tex; mode=display">
\begin{aligned}
\angle{AO_3P}&=\arccos\left(\frac{\left|\overrightarrow{O_3A}\right|^2+\left|\overrightarrow{O_3P}\right|^2-\left|\overrightarrow{AP}\right|^2}{2\left|\overrightarrow{O_3A}\right|\left|\overrightarrow{O_3P}\right|}\right) \quad 
\text{其中}\left\{\begin{aligned}
\left|\overrightarrow{AP}\right|&=\sqrt{x_p^2+y_p^2+z_p^2-l_1^2}\\
\left|\overrightarrow{O_3A}\right|&=\sqrt{l_2}\\
\left|\overrightarrow{O_3P}\right|&=\sqrt{l_3}
\end{aligned}\right.\\
&=\arccos\left(
\frac{(l_1+l_2+l_3)-(x_p^2+y_p^2+z_p^2)}{2\sqrt{l_2l_3}}
\right)
\end{aligned}</script><p>则可求出 $\left|\theta_3\right|=\pi-\angle{AO_3P}$ ，选定逆时针为正，则 $\theta_3=\left|\theta_3\right|$ </p>
</li>
<li><p>求 $\theta_2$ </p>
<p>由前文的正运动学公式 $(1)$ 可得：</p>
<script type="math/tex; mode=display">
\left\{\begin{aligned}
x_{p} &= \left(l_{3} \cos \theta_{3}+l_{2}\right) \sin \theta_{2}+l_{3} \sin \theta_{3} \cos \theta_{2}\\
 y_{p} &= -l_{3} \sin \theta_{1} \cos \left(\theta_{2}+\theta_{3}\right)+l_{1} \cos \theta_{1}-l_{2} \cos \theta_{2} \sin \theta_{1}\\
z_{p} &= l_{3} \cos \theta_{1} \cos \left(\theta_{2}+\theta_{3}\right)+l_{1} \sin \theta_{1}+l_{2} \cos \theta_{1} \cos \theta_{2}
\end{aligned}\right.</script><p>可以求出</p>
<script type="math/tex; mode=display">
\begin{align}
y_{p} \sin \theta_{1}-z_{p} \cos \theta_{1} & = -l_{3} \cos \left(\theta_{2}+\theta_{3}\right)\left(\sin ^{2} \theta_{1}+\cos ^{2} \theta_{1}\right)-l_{2} \cos \theta_{2}\left(\sin ^{2} \theta_{1}+\cos ^{2} \theta_{1}\right) \\ & = l_{3} \sin \theta_{3} \sin \theta_{2}-\left(l_{3} \cos \theta_{3}+l_{2}\right) \cos \theta_{2}
\end{align}</script><p>同除 $x_p$ </p>
<script type="math/tex; mode=display">
\begin{aligned}
\frac{y_{p} \sin \theta_{1}-z_{p} \cos \theta_{1}}{x_{p}} & = \frac{l_{3} \sin \theta_{3} \sin \theta_{2}-\left(l_{3} \cos \theta_{3}+l_{2}\right) \cos \theta_{2}}{\left(l_{3} \cos \theta_{3}+l_{2}\right) \sin \theta_{2}+l_{3} \sin \theta_{3} \cos \theta_{2}}
\end{aligned}</script><p>令 $\left\{\begin{aligned}<br>a_1&amp;=y_p \sin \theta_1-z_p \cos \theta_1 \\<br>a_2&amp;=x_p \\<br>m_1&amp;=l_3 \sin \theta_3 \\<br>m_2&amp;=l_3 \cos \theta_3+l_2<br>\end{aligned}<br>\right.$ ，上式可以表示为：</p>
<script type="math/tex; mode=display">
\begin{aligned}
\frac{a_1}{a_2}&=\frac{m_1 \sin \theta_2-m_2 \cos \theta_2}{m_1 \cos \theta_2+m_2 \sin \theta_2} \\&=\frac{m_1 \tan \theta_2-m_2}{m_1+m_2 \tan \theta_2}\quad 
\end{aligned}</script><p>同除 $\cos(\theta_2)$ 可以解得：</p>
<script type="math/tex; mode=display">
\begin{aligned}
\tan(\theta_2)=\frac{a_1 m_1+a_2 m_2}{a_2 m_1-a_1 m_2}
\end{aligned}</script><p>即可求出 $\theta_2$ ：</p>
<script type="math/tex; mode=display">
\begin{aligned}
\theta_2=\arctan \left(\frac{a_1 m_1+a_2 m_2}{a_2 m_1-a_1 m_2}\right)
\end{aligned}</script></li>
</ol>
<p>至此完成逆运动学求解。</p>
<h4 id="雅可比矩阵"><a href="#雅可比矩阵" class="headerlink" title="雅可比矩阵"></a>雅可比矩阵</h4><p>对前文的正运动学公式 $(1)$ 求导：</p>
<script type="math/tex; mode=display">
\left\{\begin{aligned}
\dot{x}_p= & 0 \cdot \dot{\theta}_1+\left(l_3 \cos \left(\theta_2+\theta_3\right)+l_2 \cos \theta_2\right) \cdot \dot{\theta}_2+l_3 \cos \left(\theta_2+\theta_3\right) \cdot \dot{\theta}_3 \\
\dot{y}_p= & \left(-l_1 \sin \theta_1-l_2 \cos \theta_1 \cos \theta_2-l_3 \cos \theta_1 \cos \left(\theta_2+\theta_3\right)\right) \cdot \dot{\theta}_1+ \\
& \left(l_2 \sin \theta_1 \sin \theta_2+l_3 \sin \theta_1 \sin \left(\theta_2+\theta_3\right)\right) \cdot \dot{\theta}_2 + l_3 \sin \theta_1 \sin \left(\theta_2+\theta_3\right) \cdot \dot{\theta}_3 \\
\dot{z}_p= & \left(l_1 \cos \theta_1-l_2 \sin \theta_1 \cos \theta_2-l_3 \sin \theta_1 \cos \left(\theta_2+\theta_3\right)\right) \cdot \dot{\theta}_1+ \\
& \left(-l_2 \cos \theta_1 \sin \theta_2-l_3 \cos \theta_1 \sin \left(\theta_2+\theta_3\right)\right) \cdot \dot{\theta}_2+\left(-l_3 \cos \theta_1 \sin \left(\theta_2+\theta_3\right)\right) \cdot \dot{\theta}_3
\end{aligned}
\right.</script><p>整理成矩阵形式：</p>
<script type="math/tex; mode=display">
\begin{bmatrix}\dot{x}_{p}\\ \dot{y}_{p}\\ \dot{z}_{p}\end{bmatrix}=\begin{bmatrix}J_{11} & J_{12} & J_{13}\\ J_{21} & J_{22} & J_{23}\\ J_{31} & J_{32} & J_{33}\end{bmatrix}\cdot\begin{bmatrix}\dot{\theta}_1\\ \dot{\theta}_2\\ \dot{\theta}_3\end{bmatrix}=\boldsymbol{J}\cdot\begin{bmatrix}\ddot{\theta}_1\\ \dot{\theta}_2\\ \dot{\theta}_3\end{bmatrix}
\tag{2}</script><p>对其求逆即可得到逆雅可比</p>
<script type="math/tex; mode=display">
\begin{bmatrix}\dot{\theta_1}\\\dot{\theta_2}\\\dot{\theta_3}\end{bmatrix}=\boldsymbol{J}^{-1}\begin{bmatrix}\dot{x}_p\\\dot{y}_p\\\dot{z}_p\end{bmatrix}
\tag{3}</script><h3 id="单腿静力学"><a href="#单腿静力学" class="headerlink" title="单腿静力学"></a>单腿静力学</h3><p>当机器人腿部静止于地面，其关节力矩 $\boldsymbol{\tau}=\begin{bmatrix}\tau_1\\\tau_2\\\tau_3\end{bmatrix}$ ，足端对地面的作用力 $\boldsymbol{F}=\begin{bmatrix}F_x\\F_y\\F_z\end{bmatrix}$ </p>
<p>可以得到其关系</p>
<script type="math/tex; mode=display">
\tau_1\dot{\theta_1}+\tau_2\dot{\theta_2}+\tau_3\dot{\theta_3}=F_x\dot{x_p}+F_y\dot{y_p}+F_z\dot{z_p}</script><p>整理成矩阵形式</p>
<script type="math/tex; mode=display">
\begin{aligned}\begin{bmatrix}\tau_1&\tau_2&\tau_3\end{bmatrix}\begin{bmatrix}\dot{\theta}_1\\\dot{\theta}_2\\\dot{\theta}_3\end{bmatrix}&=\begin{bmatrix}F_{x}&F_{y}&F_{z}\end{bmatrix}\begin{bmatrix}\dot{x}_{p}\\\dot{y}_{p}\\\dot{z}_{p}\end{bmatrix}\\
\boldsymbol{\tau}^T\cdot\dot{\boldsymbol{\theta}}&=\boldsymbol{F}^T\cdot \boldsymbol{J}\cdot\dot{\boldsymbol{\theta}}\\
\end{aligned}</script><p>则可以得到：</p>
<script type="math/tex; mode=display">
\boldsymbol{\tau}=\boldsymbol{J}^T\cdot \boldsymbol{F}</script><p>同样也可以通过关节力矩得到足端对地面的力</p>
<script type="math/tex; mode=display">
\boldsymbol{F}=\boldsymbol{J}^{-T}\cdot \boldsymbol{\tau}</script><p>地面对足端的力 $\boldsymbol{F}’=-\boldsymbol{F}$ </p>
<h3 id="四足运动学"><a href="#四足运动学" class="headerlink" title="四足运动学"></a>四足运动学</h3><h4 id="改变姿态"><a href="#改变姿态" class="headerlink" title="改变姿态"></a>改变姿态</h4><p>目标：已知机身姿态，求关节角度</p>
<p>令足端静止在地面上，将右前腿 $P_0$ 点设为世界坐标系 $\{s\}$ 的原点，则 $\boldsymbol{p}_{si}$ 为常量</p>
<p>当 $\{s\}$ 和 $\{b\}$ 平行，此时 $\boldsymbol{R}_{sb}=\boldsymbol{I}$ ，可以得到四条腿相对于世界坐标系的位置：</p>
<script type="math/tex; mode=display">
\begin{aligned}
\boldsymbol{p}_{si}&=\boldsymbol{R}_{sb}\cdot[\boldsymbol{p}_{bi}(0)-\boldsymbol{p}_{b0}(0)]\\
&=\boldsymbol{I}\cdot[\boldsymbol{p}_{bi}(0)-\boldsymbol{p}_{b0}(0)]\\
&=\boldsymbol{p}_{bi}(0)-\boldsymbol{p}_{b0}(0)
\end{aligned}</script><p>在初始状态下，世界坐标系到机身坐标系的齐次变换矩阵为</p>
<script type="math/tex; mode=display">
\boldsymbol{T}_{sb}(0)=
\left[\begin{matrix}{\boldsymbol{R}_{sb}}&{\boldsymbol{O}_{s}}\\{\boldsymbol{0}_{1\times3}}&{1}\\\end{matrix}\right]=
\left[\begin{matrix}{\boldsymbol{I}_{3}}&{-\boldsymbol{p}_{b0}(0)}\\{\boldsymbol{0}_{1\times3}}&{0}\\\end{matrix}\right]</script><p>此时改变机身姿态，将其分解为平移与旋转 $\left\{<br>\begin{aligned}<br>\text{平移}&amp;\quad p_d\\<br>\text{旋转}&amp;\quad rpy(\alpha\beta\gamma)<br>\end{aligned}<br>\right.$ </p>
<script type="math/tex; mode=display">
\boldsymbol{T}_{sb}=\left[\begin{matrix}\boldsymbol{R}_{z}(\alpha)\boldsymbol{R}_{y}(\beta)\boldsymbol{R}_{x}(\gamma)&-\boldsymbol{p}_{b0}(0)+\boldsymbol{p}_{d}\\\boldsymbol{0}_{1\times3}&1\end{matrix}\right]</script><p>即可求出机身坐标系下的足端坐标</p>
<script type="math/tex; mode=display">
\boldsymbol{p}_{bi}=\boldsymbol{T}_{bs}\cdot \boldsymbol{p}_{si}=\boldsymbol{T}_{sb}^{-1}\cdot \boldsymbol{p}_{si}</script><p>经过平移可以得到机器人单腿坐标系下的足端坐标，通过运动学逆解可以得到关节角度。</p>
<h4 id="足端速度"><a href="#足端速度" class="headerlink" title="足端速度"></a>足端速度</h4><p>足端速度由两方面叠加产生</p>
<ol>
<li>关节转动产生的足端速度，利用雅可比矩阵可以求得： $\boldsymbol{v}_{bj}=\boldsymbol{J}\dot{\boldsymbol{\theta}}$ </li>
<li>机身移动或旋转产生的足端速度： $\boldsymbol{v}_{be}$ ，此项待求</li>
</ol>
<p>首先考虑刚体上一点的速度与加速度。在刚体平移或转动时，对于刚体上位置为 $\boldsymbol{p}$ 的质点$ P$ ，只考虑平移不考虑旋转，即只需要研究速度 $\dot{\boldsymbol{p}}$ 与加速度 $\ddot{\boldsymbol{p}}$ 。</p>
<p>设刚体在 $\{b\}$ 中的平移速度为 $\boldsymbol{v}_b$ 、旋转速度为 $\boldsymbol{\omega}_b$ ，即原点 $\boldsymbol{p}_O$ 的平移速度为 $\boldsymbol{v}_b$ 。刚体上位于 $\boldsymbol{p}_P$ 的质点以 $\boldsymbol{v}_b$ 平移，以 $\boldsymbol{\omega}_b$ 绕 $\boldsymbol{p}_O$ 旋转，则：</p>
<script type="math/tex; mode=display">
\dot{\boldsymbol{p}}_P=\boldsymbol{v}_b+\boldsymbol{w}_b\times(\boldsymbol{p}_P-\boldsymbol{p}_O)=\boldsymbol{v}_b+[\boldsymbol{w}_b]_\times(\boldsymbol{p}_P-\boldsymbol{p}_O)</script><p>对等式两边求导可得：</p>
<script type="math/tex; mode=display">
\begin{aligned}\ddot{\boldsymbol{p}}_P&=\dot{\boldsymbol{v}}_b+[\dot{\boldsymbol{\omega}}_b]_\times(\boldsymbol{p}_P-\boldsymbol{p}_O)+[\boldsymbol{\omega}_b]_\times(\dot{\boldsymbol{p}}_P-\dot{\boldsymbol{p}}_O)\quad\text{其中 }\dot{\boldsymbol{p}}_O=\boldsymbol{v}_b\\&=\dot{\boldsymbol{v}}_b+[\boldsymbol{\omega}_b]_\times(\boldsymbol{p}_P-\boldsymbol{p}_O)+[\boldsymbol{\omega}_b]_\times[\boldsymbol{\omega}_b]_\times(\boldsymbol{p}_P-\boldsymbol{p}_O)\end{aligned}</script><p>当前时刻原点与 $\{b\}$ 重合，$\boldsymbol{p}_O=\boldsymbol{0}$  ，则:</p>
<script type="math/tex; mode=display">
\begin{aligned}\dot{\boldsymbol{p}}_P&=\boldsymbol{v}_b+[\boldsymbol{\omega}_b]_\times \boldsymbol{p}_P\\\ddot{\boldsymbol{p}}_P&=\dot{\boldsymbol{v}}_b+[\dot{\boldsymbol{\omega}}_b]_\times \boldsymbol{p}_P+[\boldsymbol{\omega}_b]_\times[\boldsymbol{\omega}_b]_\times \boldsymbol{p}_P\end{aligned}
\tag{4}</script><p>将机器人视为刚体，足端牵连速度为：（式中的bfB代表：{b}下feet2body）</p>
<script type="math/tex; mode=display">
\boldsymbol{v}_{be}=\boldsymbol{v}_b+[\boldsymbol{\omega}_b]_\times \boldsymbol{p}_{bfB}</script><p>结合开头的叠加， $\{s\}$ 下足端的速度可以表示为：</p>
<script type="math/tex; mode=display">
\begin{aligned}
\boldsymbol{v}_{sf}
&=\boldsymbol{R}_{sb}\left(\boldsymbol{v}_{be}+\boldsymbol{v}_{bj}\right)\\
&=\boldsymbol{R}_{sb}\boldsymbol{v}_{b}+\boldsymbol{R}_{sb}[\boldsymbol{\omega}_{b}]_\times \boldsymbol{p}_{bfB}+J\dot{\theta})\\
&=\boldsymbol{v}_{s}+\boldsymbol{R}_{sb}([\boldsymbol{\omega}_{b}]_\times \boldsymbol{p}_{bfB}+J\dot{\theta})
\end{aligned}</script><p>但式中的 $\boldsymbol{v}_s$ 无法测得。</p>
<p> $\{s\}$ 下足端相对于机身的速度可以表示为：</p>
<script type="math/tex; mode=display">
\boldsymbol{v}_{sfB}=\boldsymbol{v}_{sf}-\boldsymbol{v}_{s}=\boldsymbol{R}_{sb}([\boldsymbol{\omega}_{b}]_\times \boldsymbol{p}_{bfB}+J\dot{\theta})
\tag{5}</script><h3 id="四足动力学"><a href="#四足动力学" class="headerlink" title="四足动力学"></a>四足动力学</h3><h4 id="单刚体动力学"><a href="#单刚体动力学" class="headerlink" title="单刚体动力学"></a>单刚体动力学</h4><p>对于密度 $\rho(x,y,z)$ ，质量 $m=\int_z\int_y\int_x\rho(x,y,z)\mathrm{d}x\mathrm{d}y\mathrm{d}z=\int_B\rho\mathrm{d}V$ 的单刚体，将物体坐标系 $\{b\}$ 建在重心上，则 $\int_{B}\rho \boldsymbol{p}_{b}\mathrm{d}V=\boldsymbol{0}_{3\times1}$ ， $\int_{B}\rho [\boldsymbol{p}_{b}]\mathrm{d}V=\boldsymbol{0}_{3\times3}$ 。</p>
<p>根据牛二定律 $F=ma$ 与式 $(4)$ ，可以求出重心处所受的合外力 $\boldsymbol{f}_b$ ：</p>
<script type="math/tex; mode=display">
\boldsymbol{f}_{b}=\int_{B}\rho \ddot{\boldsymbol{p}}_{b}\mathrm{d}V=\int_{B}\rho(\dot{\boldsymbol{v}}_{b}+[\dot{\boldsymbol{\omega}}_{b}]_\times \boldsymbol{p}_{b}+[\boldsymbol{\omega}_b]_\times[\boldsymbol{\omega}_b]_\times \boldsymbol{p}_{b})\mathrm{d}V</script><p>提取常量 $\boldsymbol{v}_b$ 和 $\boldsymbol{\omega}_b$ ：</p>
<script type="math/tex; mode=display">
\boldsymbol{f}_{b}=\dot{\boldsymbol{v}}_{b}\int_{B}\rho \mathrm{d}V+[\dot{\boldsymbol{\omega}}_{b}]_\times \int_{B}\rho \boldsymbol{p}_{b}dV+[\boldsymbol{\omega}_{b}]_\times [\boldsymbol{\omega}_{b}]_\times \int_{B}\rho \boldsymbol{p}_{b}\mathrm{d}V</script><p>第一项中的 $\int_{B}\rho \mathrm{d}V=m$ ， $\int_{B}\rho \boldsymbol{p}_{b}dV=0$ ，则上式整理为：</p>
<script type="math/tex; mode=display">
\boldsymbol{f}_b = m \dot{\boldsymbol{v}}_b
\tag{6}</script><p>计算重心处的合外力矩（力矩的计算公式为 $\boldsymbol{M}=\boldsymbol{p}\times \boldsymbol{f}$ ）：</p>
<script type="math/tex; mode=display">
\begin{aligned}
\boldsymbol{M}_b&=\int_{B}\left[\boldsymbol{p}_{b}\right]_\times\mathrm{d}\boldsymbol{f}=\int_{B}\left[\boldsymbol{p}_{b}\right]_\times\rho \ddot{\boldsymbol{p}}_{b}\mathrm{d}V\\
&=
\underset{①}{\underline{\int_{B}\rho [\boldsymbol{p}_{b}]_\times\mathrm{d}V\cdot \dot{v}_{b}}}+
\underset{②}{\underline{\int_{B}\rho[\boldsymbol{p}_{b}]_\times[\dot{\boldsymbol{\omega}}_{b}]_\times \boldsymbol{p}_{b}\mathrm{d}V}}+
\underset{③}{\underline{\int_{B}\rho[\boldsymbol{p}_{b}]_\times[\boldsymbol{\omega}_b]_\times[\boldsymbol{\omega}_b]_\times \boldsymbol{p}_{b}\mathrm{d}V}}
\end{aligned}</script><p>分开看这三项：</p>
<ol>
<li><p>对于式①：</p>
<script type="math/tex; mode=display">
\int_{B}\rho [\boldsymbol{p}_{b}]_\times\mathrm{d}V=0</script></li>
<li><p>对于式②：（ $\boldsymbol{a} \times \boldsymbol{b} = -\boldsymbol{b} \times \boldsymbol{a}$ ）</p>
<script type="math/tex; mode=display">
\begin{aligned}
 \int_{B}\rho[\boldsymbol{p}_b]_\times[\dot{\boldsymbol{\omega}}_b]_\times \boldsymbol{p}_b\mathrm{d}V&=-\int_{B}\rho[\boldsymbol{p}_b]_\times[\boldsymbol{p}_b]_\times\dot{\boldsymbol{\omega}}_b\mathrm{d}V\\
 &=\underline{\left(-\int_{B}\rho[\boldsymbol{p}_b]_\times[\boldsymbol{p}_b]_\times\mathrm{d}V\right)}\cdot\dot{\boldsymbol{\omega}}_b\\
 &=\underline{\boldsymbol{I}_b}\dot{\boldsymbol{\omega}}_b
 \end{aligned}</script><p> 定义刚体惯性张量 $\boldsymbol{I}_b=-\int_{B}\rho[\boldsymbol{p}_b]_\times[\boldsymbol{p}_b]_\times\mathrm{d}V$ </p>
</li>
<li><p>对于式③：（ $[\boldsymbol{a}]_\times[\boldsymbol{b}]_\times \boldsymbol{c}=(\boldsymbol{a}^{T}\boldsymbol{c})\boldsymbol{b}-(\boldsymbol{a}^{T}\boldsymbol{b})\boldsymbol{c}$ ， $\boldsymbol{a}\times \boldsymbol{a}=[\boldsymbol{a}]_\times \boldsymbol{a}=\boldsymbol{0}$ ）</p>
<script type="math/tex; mode=display">
\begin{aligned}\int_{\mathcal{B}}\rho[\boldsymbol{p}_b]_\times[\boldsymbol{\omega}_b]_\times \boldsymbol{p}_b\mathrm{d}V&=\int_{\mathcal{B}}\rho[\boldsymbol{p}_b]_\times\left[(\boldsymbol{\omega}_b^T\boldsymbol{p}_b)\boldsymbol{\omega}_b-(\boldsymbol{\omega}_b^T\boldsymbol{\omega}_b)\boldsymbol{p}_b\right]\mathrm{d}V\\&=\int_{\mathcal{B}}\rho[(\boldsymbol{\omega}_b^T\boldsymbol{p}_b)[\boldsymbol{p}_b]_\times\boldsymbol{\omega}_b-(\boldsymbol{\omega}_b^T\boldsymbol{\omega}_b)[\boldsymbol{p}_b]_\times \boldsymbol{p}_b]\mathrm{d}V\\&=\int_{\mathcal{B}}\rho[(\boldsymbol{\omega}_b^T\boldsymbol{p}_b)[\boldsymbol{p}_b]_\times\boldsymbol{\omega}_b-\boldsymbol{0}]\mathrm{d}V\\&=-\int_{\mathcal{B}}\rho[(\boldsymbol{\omega}_b^T\boldsymbol{p}_b)[\boldsymbol{\omega}_b]_\times \boldsymbol{p}_b-\boldsymbol{0}]\mathrm{d}V\\
&=-\int_B\rho[(\boldsymbol{\omega}_b+\boldsymbol{p}_b)[\boldsymbol{\omega}_b]_\times \boldsymbol{p}_b-(\boldsymbol{p}_b^T\boldsymbol{p}_b)[\boldsymbol{\omega}_b]_\times \boldsymbol{\omega}_b]\mathrm{d}V\\&=-\int_B\rho[\boldsymbol{\omega}_b]_\times[(\boldsymbol{\omega}_b^T\boldsymbol{p}_b)\boldsymbol{p}_b-(\boldsymbol{p}_b^T\boldsymbol{p}_b)\boldsymbol{\omega}_b]\mathrm{d}V\\
&=-\int_{B}\rho[\boldsymbol{\omega}_b]_\times[\boldsymbol{p}_b]_\times[\boldsymbol{p}_b]_\times\boldsymbol{\omega}_b\mathrm{d}V\\&=[\boldsymbol{\omega}_b]_\times\left(\underline{-\int_{B}\rho[\boldsymbol{p}_b]_\times[\boldsymbol{p}_b]_\times\mathrm{d}V}\right)\boldsymbol{\omega}_b\\&=[\boldsymbol{\omega}_b]_\times\underline{\boldsymbol{I}_{b}}\boldsymbol{\omega}_b
\end{aligned}</script><p>倒数第二项的下划线部分即为惯性张量。</p>
</li>
</ol>
<p>综上可以得到旋转刚体的欧拉方程：</p>
<script type="math/tex; mode=display">
M_b=\boldsymbol{I}_{b}\dot{\boldsymbol{\omega}}_{b}+[\boldsymbol{\omega}_{b}]_\times \boldsymbol{I}_{b}\boldsymbol{\omega}_{b}
\tag{7}</script><p>上式中的惯性张量：</p>
<script type="math/tex; mode=display">
\begin{aligned}
\boldsymbol{I}_{b}& =-\int_{B}\rho[\boldsymbol{p}_{b}]_\times[\boldsymbol{p}_{b}]_\times\mathrm{d}V  \\
&=-\int_{B}\rho\left[\begin{matrix}{0}&{-p_{z}}&{p_{y}}\\{p_{z}}&{0}&{-p_{x}}\\{-p_{y}}&{p_{x}}&{0}\\\end{matrix}\right]\left[\begin{matrix}{0}&{-p_{z}}&{p_{y}}\\{p_{z}}&{0}&{-p_{x}}\\{-p_{y}}&{p_{x}}&{0}\\\end{matrix}\right]\mathrm{d}V \\
&=\int_{B}\rho\left[\begin{matrix}{p_{y}^{2}+p_{z}^{2}}&{-p_{x}p_{y}}&{-p_{x}p_{z}}\\{-p_{x}p_{y}}&{p_{x}^{2}+p_{z}^{2}}&{-p_{y}p_{z}}\\{-p_{x}p_{z}}&{-p_{y}p_{z}}&{p_{x}^{2}+p_{y}^{2}}\\\end{matrix}\right]\mathrm{d}V \\
&=\begin{bmatrix}I_{xx}&I_{xy}&I_{xz}\\I_{xy}&I_{yy}&I_{yz}\\I_{xz}&I_{yz}&I_{zz}\end{bmatrix}
\end{aligned}</script><p>即可以得到下面的结论。可以计算形状不规则、密度不均匀的物体。</p>
<script type="math/tex; mode=display">
\begin{cases}
\boldsymbol{I}_{xx}=\int_{B}\rho\left(p_y^2+p_z^2\right)\mathrm{d}V\\
\boldsymbol{I}_{yy}=\int_{B}\rho\left(p_x^2+p_z^2\right)\mathrm{d}V\\
\boldsymbol{I}_{zz}=\int_{B}\rho\left(p_x^2+p_y^2\right)\mathrm{d}V\\
\boldsymbol{I}_{xy}=-\int_{B}\rho p_xp_y\mathrm{d}V\\
\boldsymbol{I}_{xz}=-\int_{B}\rho p_xp_z\mathrm{d}V\\
\boldsymbol{I}_{yz}=-\int_{B}\rho p_yp_z\mathrm{d}V
\end{cases}</script><p>例如对于长方体：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://fan-ziqi.oss-cn-beijing.aliyuncs.com/img/image-20230831155100793.png" alt="image-20230831155100793" style="zoom:50%;"></p>
<script type="math/tex; mode=display">
\boldsymbol{I}_b=\frac1{12}\begin{bmatrix}m(\omega^2+h^2)&0&0\\0&m(l^2+h^2)&0\\0&0&m(l^2+\omega^2)\end{bmatrix}</script><p>在机身坐标系中， $\boldsymbol{I}_b$ 为常量（只与形状、密度分布有关），刚体旋转后世界坐标系下的 $\boldsymbol{I}_s$ 会改变。</p>
<h4 id="单刚体动能"><a href="#单刚体动能" class="headerlink" title="单刚体动能"></a>单刚体动能</h4><p>由式 $(4)$ ，可以得到刚体整体的动能：（ $v_x^2+v_y^2+v_z^2=\boldsymbol{v}^T\boldsymbol{v}$ ）</p>
<script type="math/tex; mode=display">
\begin{aligned}K&=\int_B\frac{1}{2}\rho \boldsymbol{v}^T\boldsymbol{v}\mathrm{d}V\\&=\frac12\int_B\rho(\boldsymbol{v}_b+[\boldsymbol{\omega}_b]_\times \boldsymbol{p}_b)^T(\boldsymbol{v}_b+[\boldsymbol{\omega}_b]_\times \boldsymbol{p}_b)\mathrm{d}V\\&=\frac12\int_B\rho(\boldsymbol{v}_b^T+\boldsymbol{p}_b^T[\boldsymbol{\omega}_b]_\times^T)\left(\boldsymbol{v}_b+[\boldsymbol{\omega}_b]_\times \boldsymbol{p}_b\right)\mathrm{d}V\\
&=
\underset{①}{\underline{\frac12\int_B\rho \underset{与\boldsymbol{v}_b有关}{\underline{\boldsymbol{v}_b^T\boldsymbol{v}_b}}\mathrm{d}V}}+
\underset{②}{\underline{\frac12\boldsymbol{v}_b^T[\boldsymbol{\omega}_b]_\times\underset{0}{\underline{\int _B\rho \boldsymbol{p}_b\mathrm{d}V}}}}+
\underset{③}{\underline{\frac12\underset{0}{\underline{\int_B\rho \boldsymbol{p}_b^T\mathrm{d}V}}[\boldsymbol{\omega}_b]_\times^T\boldsymbol{v}_b}}+
\underset{④}{\underline{\frac12\int_B\rho \boldsymbol{p}_b^T\underset{与\boldsymbol{\omega}_b有关}{\underline{[\boldsymbol{\omega}_b]_\times^T[\boldsymbol{\omega}_b]_\times}}\boldsymbol{p}_b\mathrm{d}V}}\end{aligned}</script><p>分开看这四项：</p>
<ol>
<li><p>式②、③为0</p>
</li>
<li><p>式①与 $\boldsymbol{v}_b$ 有关，定义为移动动能 $K_m$ </p>
<script type="math/tex; mode=display">
\begin{aligned}
K_{m}=& \frac{1}{2}\int_{B}\rho \boldsymbol{v}_{b}^{\mathrm{T}}\boldsymbol{v}_{b}\:\mathrm{d}V  \\
=& \frac{1}{2}\int_{B}\rho\:\mathrm{d}V\boldsymbol{v}_{b}^{\mathrm{T}}\boldsymbol{v}_{b}  \\
=& \frac{1}{2}m\boldsymbol{v}_{b}^{\mathrm{T}}\boldsymbol{v}_{b} 
\end{aligned}</script></li>
<li><p>式③与 $\boldsymbol{\omega}_b$ 有关，定义为转动动能 $K_t$ </p>
<script type="math/tex; mode=display">
\begin{aligned}
K_t&=\frac12\int_B\rho \boldsymbol{p}_b^T[\boldsymbol{\omega}_b]_\times^T[\boldsymbol{\omega}_b]_\times \boldsymbol{p}_b\mathrm{d}V\\&=-\frac12\int_B\rho \boldsymbol{p}_b^T[\boldsymbol{\omega}_b]_\times[\boldsymbol{\omega}_b]_\times \boldsymbol{p}_b\mathrm{d}V\\
&=-\frac{1}{2}\int_{B}\rho \boldsymbol{p}_{b}^{T}[(\boldsymbol{\omega}_{b}^{T}\boldsymbol{p}_{b})\boldsymbol{\omega}_{b}-(\boldsymbol{\omega}_{b}^{T}\boldsymbol{\omega}_{b})\boldsymbol{p}_{b}]dV \\
&=-\frac{1}{2}\int_{B}\rho [(\boldsymbol{\omega}_{b}^{T}\boldsymbol{p}_{b})(\boldsymbol{p}_{b}^{T}\boldsymbol{\omega}_{b})-(\boldsymbol{\omega}_{b}^{T}\boldsymbol{\omega}_{b})(\boldsymbol{p}_{b}^{T}\boldsymbol{p}_{b})]dV \\
&=-\frac{1}{2}\int_{B}\rho [(\boldsymbol{p}_{b}^{T}\boldsymbol{\omega}_{b})(\boldsymbol{\omega}_{b}^{T}\boldsymbol{p}_{b})-(\boldsymbol{p}_{b}^{T}\boldsymbol{p}_{b})(\boldsymbol{\omega}_{b}^{T}\boldsymbol{\omega}_{b})]dV \\
&=-\frac{1}{2}\int_{B}\rho \boldsymbol{\omega}_{b}^{T}\left[(\boldsymbol{p}_{b}^{T}\boldsymbol{\omega}_{b})\boldsymbol{p}_{b}-(\boldsymbol{p}_{b}^{T}\boldsymbol{p}_{b})\boldsymbol{\omega}_{b}\right]dV \\
&=\frac{1}{2}\boldsymbol{\omega}_{b}^{T}\int_{B}-\rho[\boldsymbol{p}_{b}]_\times[\boldsymbol{p}_{b}]_\times\boldsymbol{\omega}_{b}dV \\
&=\frac{1}{2}\boldsymbol{\omega}_b^{T}\boldsymbol{I}_{b}\boldsymbol{\omega}_b
\end{aligned}</script><p>在不同坐标系下，刚体的转动动能 $K_t$ 相等。又由 $\boldsymbol{\omega}_{b}=\boldsymbol{R}_{bs}\boldsymbol{\omega}_{s}$ ，故：</p>
<script type="math/tex; mode=display">
\begin{aligned}
K_{st}& =K_{bt}  \\
\frac{1}{2}\boldsymbol{\omega}_{s}^{\mathrm{T}}\boldsymbol{I}_{s}\boldsymbol{\omega}_{s}& =\frac12\boldsymbol{\omega}_b^\mathrm{T}\boldsymbol{I}_b\boldsymbol{\omega}_b  \\
\boldsymbol{\omega}_{s}^{\mathrm{T}}\boldsymbol{I}_{s}\boldsymbol{\omega}_{s}& =(\boldsymbol{R}_{bs}\boldsymbol{\omega}_{s})^{\mathrm{T}}\boldsymbol{I}_{b}(\boldsymbol{R}_{bs}\boldsymbol{\omega}_{s})  \\
\boldsymbol{\omega}_{s}^{\mathrm{T}}\boldsymbol{I}_{s}\boldsymbol{\omega}_{s}& =\boldsymbol{\omega}_{s}^{\mathrm{T}}(\boldsymbol{R}_{sb}\boldsymbol{I}_{b}\boldsymbol{R}_{sb}^{\mathrm{T}})\boldsymbol{\omega}_{s} \\
\boldsymbol{I}_{s}&=\boldsymbol{R}_{sb}\boldsymbol{I}_{b}\boldsymbol{R}_{sb}^\mathrm{T}
\end{aligned}</script><p>由此可以得到世界坐标系下刚体的惯性张量，这将在下一节中被用到。</p>
</li>
</ol>
<h4 id="四足动力学-1"><a href="#四足动力学-1" class="headerlink" title="四足动力学"></a>四足动力学</h4><p>目标：找到足端力与机器人运动的联系。</p>
<p>由式 $(6)$ 和 $(7)$ 可以得到：</p>
<script type="math/tex; mode=display">
\begin{cases}
\boldsymbol{f}_b=m\dot{\boldsymbol{v}}_b\\
\boldsymbol{M}_b=\boldsymbol{I}_b\dot{\boldsymbol{\omega}}_b+\underline{[\boldsymbol{\omega}_b]_\times \boldsymbol{I}_b\boldsymbol{\omega}_b}
\end{cases}</script><p>由于四足机器人运动时一般不会快速旋转，上式中 $\boldsymbol{\omega}_b$ 很小，故划线部分可以忽略。则上式变为：</p>
<script type="math/tex; mode=display">
\begin{cases}
\boldsymbol{f}_b=m\dot{\boldsymbol{v}}_b\\
\boldsymbol{M}_b=\boldsymbol{I}_b\dot{\boldsymbol{\omega}}_b
\end{cases}</script><p>在世界坐标系中同样满足上式，即为：</p>
<script type="math/tex; mode=display">
\begin{cases}
\boldsymbol{f}_s=m\dot{\boldsymbol{v}}_s\\
\boldsymbol{M}_s=\boldsymbol{I}_s\dot{\boldsymbol{\omega}}_s=\boldsymbol{R}_\mathrm{sb}\boldsymbol{I}_{b}\boldsymbol{R}_\mathrm{sb}^\mathrm{T}\dot{\boldsymbol{\omega}}_s
\end{cases}</script><p>其中，合外力 $\boldsymbol{f}_s$ 由两部分组成：</p>
<ol>
<li>重力 $mg$ </li>
<li>足端力 $\boldsymbol{f}_{is}$ </li>
</ol>
<p>合力矩 $\boldsymbol{M}_s$ 由两部分组成：</p>
<ol>
<li>重力穿过重心，力矩为 $0$ </li>
<li>足端力对重心的力矩 $\boldsymbol{p}_{gi}\times \boldsymbol{f}_{is} = [\boldsymbol{p}_{gi}]\boldsymbol{f}_{is}$ </li>
</ol>
<p>则：</p>
<script type="math/tex; mode=display">
\left\{
\begin{aligned}
&mg+\sum_{i=0}^3\boldsymbol{f}_{is}=m\dot{\boldsymbol{v}}_s\\
&\sum_{i=0}^3[\boldsymbol{p}_{ig}]_\times \boldsymbol{f}_{is}=\boldsymbol{R}_{sb}\boldsymbol{I}_b\boldsymbol{R}_{sb}^\mathrm{T}\dot{\boldsymbol{\omega}}_s
\end{aligned}
\right.
\tag{8}</script><p>整理成矩阵形式</p>
<script type="math/tex; mode=display">
\begin{bmatrix}
\boldsymbol{I}&\boldsymbol{I}&\boldsymbol{I}&\boldsymbol{I}\\
[\boldsymbol{p}_{g0}]_\times&[\boldsymbol{p}_{g1}]_\times&[\boldsymbol{p}_{g2}]_\times&[\boldsymbol{p}_{g3}]_\times\end{bmatrix}\begin{bmatrix}\boldsymbol{f}_{s0}\\\boldsymbol{f}_{s1}\\\boldsymbol{f}_{s2}\\\boldsymbol{f}_{s3}\end{bmatrix}=\begin{bmatrix}m(\dot{\boldsymbol{v}}_s-g)\\\boldsymbol{R}_{sb}\boldsymbol{I}_b\boldsymbol{R}_{sb}^\mathrm{T}\dot{\boldsymbol{\omega}}_s
\end{bmatrix}</script><p>此时完成了足端力与机器人运动的联系。但此时无法获得机器人姿态 $\boldsymbol{R}_{sb}$ ，且需要知道机器人在世界坐标系下的 $\boldsymbol{v}_s$ 、 $\boldsymbol{\omega}_s$ 。获取这些信息需要用到下一章的状态估计器。</p>
<h2 id="状态估计器"><a href="#状态估计器" class="headerlink" title="状态估计器"></a>状态估计器</h2><p>状态估计器是四足机器人系统中比较重要的一环节，通过状态估计器可以获得四足机器人质心位姿（位置和姿态角）及速度。姿态角可根据IMU通过坐标变换得到；位置和速度需要使用最小二乘法或卡尔曼滤波器求得，最终将质心位姿和速度作为机械狗的MPC+WBC控制器及单刚体动力学的反馈输入，进而形成了整个系统的闭环控制。本章节分别介绍最小二乘估计和离散卡尔曼滤波器这两个优化方法。</p>
<h3 id="最小二乘与卡尔曼滤波"><a href="#最小二乘与卡尔曼滤波" class="headerlink" title="最小二乘与卡尔曼滤波"></a>最小二乘与卡尔曼滤波</h3><p>在讲状态估计器之前有必要介绍一下最小二乘和卡尔曼滤波的关系。线性回归是一类问题的概念，而最小二乘估计、最小均方误差估计是参数估计方法，最小二乘法、Kalman、梯度下降都是参数优化方法。<strong>最小二乘是优化方法中的一种特殊情况，卡尔曼滤波是最小二乘法的一种特殊情况。</strong> 古典最小二乘中，假设了每一次测量的权重相同，但事实上这样并不合理，后来演化为加权最小二乘法，至此最小二乘估计所做的都是批处理（Batch），这样比较占内存，不符合动态系统状态估计的需要，即每一次更新输入时，都要从新计算之前所有的记录值。而后，提出递推最小二乘法，模型就不用每次都重新计算了。与递归最小二乘相似，卡尔曼滤波加入了系统内部变化的考虑。即利用process model对系统在下一时刻的状态进行预测。 当对于系统不够了解时，使用最小二乘法比较合适，而对于系统了解比较多时，可以采用Kalman滤波。改变量测噪声、系统噪声都会对Kalman滤波的效果产生影响，而不会对最小二乘滤波产生影响，而改变最小二乘的阶数会对其产生影响。</p>
<h3 id="使用IMU获得姿态"><a href="#使用IMU获得姿态" class="headerlink" title="使用IMU获得姿态"></a>使用IMU获得姿态</h3><p>使用IMU可以估计质心姿态。现有的IMU基本都可以返回四元数 $\boldsymbol{q}=\begin{bmatrix}w\\x\\y\\z\end{bmatrix}$ ，经过计算即可获得质心姿态角，其公式如下：</p>
<script type="math/tex; mode=display">
\boldsymbol{R}_{sb} = \begin{bmatrix}
1-2 y^{2}-2 z^{2} & 2 x y-2 z w & 2 x z+2 y w \\
2 x y+2 z w & 1-2 x^{2}-2 z^{2} & 2 y z-2 x w \\
2 x z-2 y w & 2 y z+2 x w & 1-2 x^{2}-2 y^{2}
\end{bmatrix}</script><p>当然，也可以通过旋转矩阵转成欧拉角（Roll、Pitch、Yaw）：</p>
<script type="math/tex; mode=display">
\begin{aligned}
\text{Roll} &= \arctan2\left(\boldsymbol{R}_{sb}(3,2), \boldsymbol{R}_{sb}(3,3)\right) \\
\text{Pitch} &= \arcsin\left(-\boldsymbol{R}_{sb}(3,1)\right) \\
\text{Yaw} &= \arctan2\left(\boldsymbol{R}_{sb}(2,1), \boldsymbol{R}_{sb}(1,1)\right)
\end{aligned}</script><p>在IMU的局部坐标系 $\{b\}$ 中：</p>
<script type="math/tex; mode=display">
\begin{aligned}m\boldsymbol{a}&=-k\boldsymbol{s}+m\boldsymbol{R}_{bs}\boldsymbol{g}\\\boldsymbol{s}&=\frac{m}{k}(\boldsymbol{R}_{bs}\boldsymbol{g}-\boldsymbol{a})\end{aligned}</script><p>上式中由于重力加速度 $\boldsymbol{g}=\begin{bmatrix}0\\ 0 \-9.8\end{bmatrix}$ 是世界坐标系下的，所以需要左乘旋转矩阵 $\boldsymbol{R}_{bs}$ 。则加速度计的读数为：</p>
<script type="math/tex; mode=display">
\begin{aligned}\boldsymbol{a}_b=\boldsymbol{a}_{out}=-\frac{k}{m}\boldsymbol{s}&=\boldsymbol{a}-\boldsymbol{R}_{bs}\boldsymbol{g}=\boldsymbol{a}-\boldsymbol{R}_{sb}^\mathrm{T}\boldsymbol{g}\end{aligned}</script><p>上述公式建立了加速度计读数与质心姿态的关系，通过左乘旋转矩阵可以计算出IMU在 $\{s\}$ 坐标系下的加速度：</p>
<script type="math/tex; mode=display">
\begin{aligned}
\boldsymbol{a}_{s}& =\boldsymbol{R}_{sb}\boldsymbol{a}  \\
&=\boldsymbol{R}_{sb}\boldsymbol{a}_{b}+\boldsymbol{R}_{sb}\boldsymbol{R}_{sb}^{T}\boldsymbol{g} \\
&=\boldsymbol{R}_{sb}\boldsymbol{a}_{b}+\boldsymbol{g}
\end{aligned}
\tag{9}</script><h3 id="状态空间模型"><a href="#状态空间模型" class="headerlink" title="状态空间模型"></a>状态空间模型</h3><p>状态估计器需要一个描述四足机器人运动状态的状态空间模型。对于一个状态空间模型需要对其进行能控性和能观性的分析，来判断此学系统是否能够被输入所控制，但本文省略这一部分的内容。本章节先介绍连续状态空间模型，再推出离散状态空间模型。</p>
<h4 id="连续状态空间模型"><a href="#连续状态空间模型" class="headerlink" title="连续状态空间模型"></a>连续状态空间模型</h4><p>“连续”指的是时间连续、定常线性系统的状态空间模型：</p>
<script type="math/tex; mode=display">
\begin{cases}\dot{\boldsymbol{x}}(t)=\boldsymbol{A}_c \boldsymbol{x}(t)+\boldsymbol{B}_c \boldsymbol{u}(t)\\
\boldsymbol{y}(t)=\boldsymbol{C}_c \boldsymbol{x}(t)\end{cases}
\tag{10}</script><p>其中：</p>
<ul>
<li>$\boldsymbol{x}(t)$ ：状态向量</li>
<li>$\boldsymbol{u}(t)$ ：控制向量</li>
<li>$\boldsymbol{y}(t)$ ：输出向量</li>
<li>$\boldsymbol{A}_c$ ：系统矩阵</li>
<li>$\boldsymbol{B}_c$ ：输入矩阵</li>
<li>$\boldsymbol{C}_c$ ：输出矩阵</li>
</ul>
<p>则 $\boldsymbol{x}$ 应为要估计的量， $\boldsymbol{y}$ 为能直接测量的量。</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://fan-ziqi.oss-cn-beijing.aliyuncs.com/img/image-20230731130212268.png" alt="image-20230731130212268" style="zoom: 33%;"></p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://fan-ziqi.oss-cn-beijing.aliyuncs.com/img/image-20230731130302869.png" alt="image-20230731130302869" style="zoom: 33%;"></p>
<p>令机身加速度 $\boldsymbol{a}_s$ 为系统输入量 $\boldsymbol{u}$ ，上式可变为标准形式：</p>
<script type="math/tex; mode=display">
\dot{\boldsymbol{x}}=
\begin{bmatrix}
\boldsymbol{0}_{3\times3}&\boldsymbol{I}_3&\boldsymbol{0}_{3\times12}\\
&\boldsymbol{0}_{3\times18}&\\
&\boldsymbol{0}_{3\times18}&
\end{bmatrix}\boldsymbol{x}+
\begin{bmatrix}\boldsymbol{0}_{3\times3}\\\boldsymbol{I}_3\\\boldsymbol{0}_{3\times3}
\end{bmatrix}
\begin{bmatrix}\boldsymbol{R}_{sb}\boldsymbol{a}_{b}+\boldsymbol{g}\end{bmatrix}
\tag{11}</script><p>对于可测量的输出变量 $\boldsymbol{y}$ ，前文通过IMU可测得 $\{s\}$ 坐标系下的机身姿态 $\boldsymbol{R}_{sb}$ ； $\{b\}$ 下的加速度 $\boldsymbol{a_b}$ 、角速度 $\boldsymbol{\omega}_b$ ；通过正向运动学，可以求出 $\{b\}$ 坐标系下足端相对于机身的位置 $\boldsymbol{p}_{bfB}$ ，转换到 $\{s\}$ 坐标系下，即 $\boldsymbol{p}_{sfB}=\boldsymbol{R}_{sb}\boldsymbol{p}_{bfB}$ (式12)，即可写出输出变量：</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://fan-ziqi.oss-cn-beijing.aliyuncs.com/img/image-20230802125435769.png" alt="image-20230802125435769" style="zoom:50%;"></p>
<p>将其写成式 $(10)$ 的标准形式：(式13)</p>
<p><img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://fan-ziqi.oss-cn-beijing.aliyuncs.com/img/image-20230802125521114.png" alt="image-20230802125521114" style="zoom:50%;"></p>
<h4 id="离散状态空间模型"><a href="#离散状态空间模型" class="headerlink" title="离散状态空间模型"></a>离散状态空间模型</h4><p>由于控制算法运行于计算机，需要对连续的状态空间模型离散化，使状态空间变量均为时间的函数。设采样时间间隔为 $\mathrm{d}t$ ，则：</p>
<script type="math/tex; mode=display">
\dot{\boldsymbol{x}}(k-1)=\frac{\boldsymbol{x}(k)-\boldsymbol{x}(k-1)}{dt}\Rightarrow \boldsymbol{x}(k)=\boldsymbol{x}(k-1)+\mathrm{d}t\dot{\boldsymbol{x}}(k-1)</script><p>将式 $(10)$ 带入</p>
<script type="math/tex; mode=display">
\begin{aligned}
\boldsymbol{x}(k)&=\boldsymbol{x}(k-1)+\mathrm{d}t\left(\boldsymbol{A}_{c}\boldsymbol{x}(k-1)+\boldsymbol{B}_{c}\boldsymbol{u}(k-1)\right)\\
&=\underline{(\boldsymbol{I}+\mathrm{d}t\boldsymbol{A}_{c})}\boldsymbol{x}(k-1)+\underline{\mathrm{d}t\boldsymbol{B}_{c}}\boldsymbol{u}(k-1)
\end{aligned}</script><p>则离散状态空间模型可以表示为：</p>
<script type="math/tex; mode=display">
\begin{aligned}
\begin{cases}\boldsymbol{x}(k)=\boldsymbol{A}\boldsymbol{x}(k-1)+\boldsymbol{B}\boldsymbol{u}(k-1)\\\boldsymbol{y}(k)=\boldsymbol{C}\boldsymbol{x}(k)\end{cases}
\quad\text{其中}\begin{cases}\boldsymbol{A}=\boldsymbol{I}+\mathrm{d}t\boldsymbol{A}_{c}\\\boldsymbol{B}=\mathrm{d}t\boldsymbol{B}_{c}\\\boldsymbol{C}=\boldsymbol{C}_{c}\end{cases}
\end{aligned}</script><h3 id="最小二乘估计"><a href="#最小二乘估计" class="headerlink" title="最小二乘估计"></a>最小二乘估计</h3><p>输出向量 $\boldsymbol{y}$ 的测量值中含有噪声向量 $\boldsymbol{v}$ ，假设状态向量 $\boldsymbol{x}_k$ 为定值 $\boldsymbol{x}$ ，离散状态空间中的 $\boldsymbol{y}$ 变为 $\boldsymbol{y}_k=\boldsymbol{C}\boldsymbol{x}+\boldsymbol{v}_k$ 。假设测量噪声 $\boldsymbol{v}\sim(0,\boldsymbol{R})$ ，其中 $\boldsymbol{R}$ 为协方差矩阵， $\boldsymbol{R}=\mathrm{diag}(\sigma_{1}^{2},\sigma_{2}^{2},\ldots,\sigma_{n}^{2})$ 。需要在有噪声的情况下获得状态向量的最优估计值 $\hat{\boldsymbol{x}}$ 。</p>
<h4 id="加权最小二乘估计"><a href="#加权最小二乘估计" class="headerlink" title="加权最小二乘估计"></a>加权最小二乘估计</h4><p>定义测量残差 $\boldsymbol{\epsilon}_{y}=\boldsymbol{y}-\boldsymbol{C}\hat{\boldsymbol{x}}$ 。根据各个传感器的误差方差定义为权重，方差越小权重越大。定义代价函数：</p>
<script type="math/tex; mode=display">
\begin{aligned}
J&=
\frac{\boldsymbol{\epsilon}_{y_{1}}^{2}}{\sigma_{1}^{2}}+
\frac{\boldsymbol{\epsilon}_{y_{2}}^{2}}{\sigma_{2}^{2}}+
\cdots+
\frac{\boldsymbol{\epsilon}_{y_{n}}^{2}}{\sigma_{n}^{2}}=\boldsymbol{\epsilon}_{y}^{T}\boldsymbol{R}^{-1}\boldsymbol{\epsilon}_{y}\\
&=(\boldsymbol{y}-\boldsymbol{C}\hat{\boldsymbol{x}})^{T}\boldsymbol{R}^{-1}(\boldsymbol{y}-\boldsymbol{C}\hat{\boldsymbol{x}})\\
&=\boldsymbol{y}^{T}\boldsymbol{R}^{-1}\boldsymbol{y}-\boldsymbol{y}^{T}\boldsymbol{R}^{-1}\boldsymbol{C}\hat{\boldsymbol{x}}-\hat{\boldsymbol{x}}^{T}\boldsymbol{C}^{T}\boldsymbol{R}^{-1}\boldsymbol{y}+\hat{\boldsymbol{x}}^{T}\boldsymbol{C}^{T}\boldsymbol{R}^{-1}\boldsymbol{C}\hat{\boldsymbol{x}}\\
\end{aligned}</script><p>求 $J$ 的偏导数 $\frac{\partial J}{\partial\hat{\boldsymbol{x}}}=-2\boldsymbol{y}^{T}\boldsymbol{R}^{-1}\boldsymbol{C}+2\hat{\boldsymbol{x}}^{T}\boldsymbol{C}^{T}\boldsymbol{R}^{-1}\boldsymbol{C}$ ，令其为 $0$ ，可以计算出 $\hat{\boldsymbol{x}}=(\boldsymbol{C}^{T}\boldsymbol{R}^{-1}\boldsymbol{C})^{-1}\boldsymbol{C}^{T}\boldsymbol{R}^{-1}\boldsymbol{y}$ 。</p>
<p>但此方法需要使用一段时间内所有的测量值 $\boldsymbol{y}$ ，其计算量及内存占用太大，故改用递推公式。</p>
<h4 id="递推最小二乘估计"><a href="#递推最小二乘估计" class="headerlink" title="递推最小二乘估计"></a>递推最小二乘估计</h4><p>定义 $\hat{\boldsymbol{x}}$ 的递推公式：（其中 $\boldsymbol{K}_k$ 为最优修正系数矩阵）</p>
<script type="math/tex; mode=display">
\begin{cases}
\boldsymbol{y}_{k}=\boldsymbol{C}\boldsymbol{x}+\boldsymbol{v}_{k}\\
\hat{\boldsymbol{x}}_{k}=\hat{\boldsymbol{x}}_{k-1}+\boldsymbol{K}_{k}(\boldsymbol{y}_{k}-\boldsymbol{C}\hat{\boldsymbol{x}}_{k-1})
\end{cases}
\tag{13}</script><p>定义 $k$ 时刻的状态估计误差：</p>
<script type="math/tex; mode=display">
\begin{aligned}
\boldsymbol{\omega}_k&=\hat{\boldsymbol{x}}-\hat{\boldsymbol{x}}_k=\hat{\boldsymbol{x}}-\hat{\boldsymbol{x}}_{k-1}-\boldsymbol{K}_k(\boldsymbol{y}_k-\boldsymbol{C}\hat{\boldsymbol{x}}_{k-1})\\
&=\boldsymbol{\omega}_{k-1}-\boldsymbol{K}_k\boldsymbol{C}(\boldsymbol{x}-\hat{\boldsymbol{x}}_{k-1})-\boldsymbol{K}_k\boldsymbol{v}_k\\
&=(\boldsymbol{I}-\boldsymbol{K}_k\boldsymbol{C})\boldsymbol{\omega}_{k-1}-\boldsymbol{K}_k\boldsymbol{v}_k
\end{aligned}
\tag{14}</script><p>再次使用二次规划，令 $k$ 时刻各状态估计误差方差和最小，则 $k$ 时刻的代价函数 $J_k$ 为：</p>
<script type="math/tex; mode=display">
\begin{aligned}J_{k}&=E\left(\omega_{k1}^{2}+\omega_{k2}^{2}+\cdots+\omega_{kn}^{2}\right)\\&=\sigma_{k1}^{2}+\sigma_{k2}^{2}+\cdots+\sigma_{kn}^{2}\\&=\mathrm{Tr}\left(\boldsymbol{P}_{k}\right)\end{aligned}</script><p>估计误差协方差 $\boldsymbol{P}_{k}=E(\boldsymbol{\omega}_{k}\boldsymbol{\omega}_{k}^{T})$ ，将式 $(14)$ 带入可以得到：</p>
<script type="math/tex; mode=display">
\begin{aligned}
\boldsymbol{P}_{k}&=E(\boldsymbol{\omega}_{k}\boldsymbol{\omega}_{k}^{T})\\
&=(\boldsymbol{I}-\boldsymbol{K}_k\boldsymbol{C})\boldsymbol{P}_{k-1}(\boldsymbol{I}-\boldsymbol{K}_k\boldsymbol{C})^T+\boldsymbol{K}_k\boldsymbol{R}\boldsymbol{K}_k^T
\end{aligned}
\tag{15}</script><p>目的为使 $J$ 最小，对其求偏导：</p>
<script type="math/tex; mode=display">
\frac{\partial J_k}{\partial \boldsymbol{K}_k}=2(\boldsymbol{I}-\boldsymbol{K}_k \boldsymbol{C})\boldsymbol{P}_{k-1}(-\boldsymbol{C}^T)+2\boldsymbol{K}_k \boldsymbol{R}=0</script><p>解得最优的 $\boldsymbol{K}_k$ 为：</p>
<script type="math/tex; mode=display">
\boldsymbol{K}_{k}=\boldsymbol{P}_{k-1}\boldsymbol{C}^{T}(\boldsymbol{R}+\boldsymbol{C}\boldsymbol{P}_{k-1}\boldsymbol{C}^{T})^{-1}
\tag{16}</script><h4 id="最小二乘估计流程总结"><a href="#最小二乘估计流程总结" class="headerlink" title="最小二乘估计流程总结"></a>最小二乘估计流程总结</h4><ol>
<li>确定初始状态的最优估计值 $\hat{\boldsymbol{x}}_0$ 和估计值的协方差 $\boldsymbol{P}_0$ 。如果对系统状态 $\boldsymbol{x}$ 完全不了解，则可以将 $\hat{\boldsymbol{x}}_0$ 设为任意值，同时令 $\boldsymbol{P}_0 = \infty \boldsymbol{I}$ ，表示无穷大的协方差，即完全不信任 $\hat{\boldsymbol{x}}_0$ 。</li>
<li>估计器运行开始，在 $k=1$ 时刻，机器人从各个传感器得到输出向量 $\boldsymbol{y}_1$ ，并根据式 $(16)$ 计算出当前时刻的最优修正系数矩阵 $\boldsymbol{K}_1=\boldsymbol{P}_0\boldsymbol{C}^{T}(\boldsymbol{R}+\boldsymbol{C}\boldsymbol{P}_0\boldsymbol{C}^{T})^{-1}$ 。根据式 $(13)$ 可以计算出当前时刻的最优估计值 $\hat{\boldsymbol{x}}_1=\hat{\boldsymbol{x}}_0+\boldsymbol{K}_1(\boldsymbol{y}_1-\boldsymbol{C}\hat{\boldsymbol{x}}_0)$ 。根据式 $(15)$ 可以计算出估计误差协方差 $\boldsymbol{P}_1=(\boldsymbol{I}-\boldsymbol{K}_1\boldsymbol{C})\boldsymbol{P}_0(\boldsymbol{I}-\boldsymbol{K}_1\boldsymbol{C})^T+\boldsymbol{K}_1\boldsymbol{R}\boldsymbol{K}_1^T$ 。 </li>
<li>当 $k=2,3,\cdots $ ，估计器重复第二步，估计值 $\hat{\boldsymbol{x}}$ 不断逼近真实状态 $\boldsymbol{x}$ 。</li>
</ol>
<h4 id="过程噪声"><a href="#过程噪声" class="headerlink" title="过程噪声"></a>过程噪声</h4><p>前文假设状态向量为定值。若状态向量是变化的，增加过程噪声 $\boldsymbol{w}$ ，且其期望为0。则离散状态空间模型变为：</p>
<script type="math/tex; mode=display">
\boldsymbol{x}_k=\boldsymbol{A}\boldsymbol{x}_{k-1}+\boldsymbol{B}\boldsymbol{u}_{k-1}+\boldsymbol{w}</script><p>状态期望为：</p>
<script type="math/tex; mode=display">
\begin{aligned}
\overline{\boldsymbol{x}_{k}}
&=E(\boldsymbol{x}_{k})=\boldsymbol{A}E(\boldsymbol{x}_{k-1})+\boldsymbol{B}E(\boldsymbol{u}_{k-1})+\underset{0}{\underline{E(\boldsymbol{w}_{k-1}}})\\
&=\boldsymbol{A}\overline{\boldsymbol{x}}_{k-1}+\boldsymbol{B}\overline{\boldsymbol{u}}_{k-1}
\end{aligned}</script><p>状态向量 $\boldsymbol{x}_k$ 的协方差为：（ $\boldsymbol{Q}=\boldsymbol{w}\boldsymbol{w}^T$ 为过程噪声协方差）</p>
<script type="math/tex; mode=display">
\begin{aligned}
P_k
&=E\left[(\boldsymbol{x}_k-\overline{\boldsymbol{x}}_k)(\boldsymbol{x}_k-\overline{\boldsymbol{x}}_k)^T\right]=\boldsymbol{A}\boldsymbol{P}_{k-1}\boldsymbol{A}^T+\boldsymbol{w}_{k-1}\boldsymbol{w}_{k-1}^T\\
&=\boldsymbol{A}\boldsymbol{P}_{k-1}\boldsymbol{A}^T+\underline{\boldsymbol{Q}}
\end{aligned}</script><h3 id="扩展卡尔曼滤波器"><a href="#扩展卡尔曼滤波器" class="headerlink" title="扩展卡尔曼滤波器"></a>扩展卡尔曼滤波器</h3><p>最小二乘估计只能对固定状态 $\boldsymbol{x}$ 进行估计，而扩展卡尔曼滤波器可以对变化的状态 $\boldsymbol{x}_k$ 进行估计。</p>
<p>TODO </p>
<h2 id="步态轨迹规划"><a href="#步态轨迹规划" class="headerlink" title="步态轨迹规划"></a>步态轨迹规划</h2><h3 id="落脚点的选取"><a href="#落脚点的选取" class="headerlink" title="落脚点的选取"></a>落脚点的选取</h3><h4 id="平移"><a href="#平移" class="headerlink" title="平移"></a>平移</h4><p>TODO 图</p>
<p>上图为四足机器人的一条腿从抬起到落下的过程，分区看图中的几个过程：</p>
<ol>
<li>➂为中性落脚点</li>
<li>➀~➁阶段为摆动相，机器人速度为 $v_x$ ，摆动时间为 $T_{swing}$ ，则 $d_{12}=v_x T_{swing}$ 。</li>
<li>➁~➃阶段为支撑相，机器人速度为 $v_x$ ，触底时间为 $T_{stance}$ ，则 $d_{23}=\Delta x=\frac{1}{2} v_x T_{stance}$ 。</li>
</ol>
<p>图中落脚点 $x_{f}=x_{b}+d_{12}+d_{23}=x_{b}+v_x T_{swing}+\frac{1}{2}v_x T_{stance}$ </p>
<p>设相位 $p_{t}=\frac{t-t_{0}}{t_{1}-t_{0}}$ ，则落脚点变为 $x_f=x_{p}(p)+v_x(1-p)T_{swing}+\frac{1}{2}v_xT_{stance}$ </p>
<p>若落脚点位于中性落脚点左侧，重力会对落脚点产生顺时针的力矩从而向右加速，所以若 $v_x &lt; v_{xd}$ ，则需左移落脚点。</p>
<script type="math/tex; mode=display">
\begin{cases}
x_{f}=x_{p}(p)+v_{x}(1-p)T_{swing}+\frac{1}{2}v_{x}T_{stance}+k_{x}(v_{x}-v_{xd}) \\
y_{f}=y_{p}(p)+v_{y}(1-p)T_{swing}+\frac12v_{y}T_{stance}+k_{y}(v_{y}-v_{yd})
\end{cases}</script><h4 id="旋转"><a href="#旋转" class="headerlink" title="旋转"></a>旋转</h4><script type="math/tex; mode=display">
\theta_f=\theta_p+\theta_0+\omega(1-p)T_{swing}+\frac{1}{2}\omega T_{stance}+k_\omega(\omega-\omega_d)</script><p>则世界坐标系下的落脚点为</p>
<script type="math/tex; mode=display">
\begin{cases}
x_{f}=R\cos\theta_{f} \\
y_{f}=R\sin\theta_{f}
\end{cases}</script><p>结合平移与旋转，落脚点坐标为：</p>
<script type="math/tex; mode=display">
\begin{cases}x_i=x_b+R\cos\theta_f+v_x(1-p)T_{swing}+\frac{1}{2}v_xT_{stance}+k_x(v_x-v_{xd})\\y_i=y_b+R\sin\theta_f+v_y(1-p)T_{swing}+\frac{1}{2}v_yT_{stance}+k_y(v_y-v_{yd})\end{cases}</script><h2 id="MPC控制器"><a href="#MPC控制器" class="headerlink" title="MPC控制器"></a>MPC控制器</h2><h3 id="目标"><a href="#目标" class="headerlink" title="目标"></a>目标</h3><p>通过MPC可以得到：</p>
<ol>
<li>质心位置、速度、加速度、旋转角度、角速度</li>
<li>足底力</li>
<li>足端位置、速度、加速度</li>
</ol>
<p>让机器狗质心跟踪最新的参考轨迹，计算未来一段时间内的足底力</p>
<h3 id="简化单刚体动力学"><a href="#简化单刚体动力学" class="headerlink" title="简化单刚体动力学"></a>简化单刚体动力学</h3><p>下面考虑单刚体动力学：</p>
<script type="math/tex; mode=display">
\begin{aligned}\ddot{\boldsymbol{p}}=\frac{\sum_{i=1}^n\boldsymbol{f}_i}{m}-\boldsymbol{g}\\\frac{d}{dt}(\boldsymbol{I}\boldsymbol{\omega})=\sum_{i=1}^n\boldsymbol{r}_i\times \boldsymbol{f}_i\end{aligned}</script><p>对上式其进行简化</p>
<ol>
<li><p>$\frac{d}{dt}(\boldsymbol{I}\boldsymbol{\omega})=\boldsymbol{I}\boldsymbol{\omega}+\boldsymbol{\omega}\times(\boldsymbol{I}\boldsymbol{\omega})\approx \boldsymbol{I}\dot{\boldsymbol{\omega}}$ ，其中 $\boldsymbol{I}=\boldsymbol{R}\boldsymbol{I}_b\boldsymbol{R}^T\approx \boldsymbol{R}_z(\psi)\boldsymbol{I}_b\boldsymbol{R}_z^T(\psi)$ </p>
</li>
<li><p>简化pitch和row</p>
<p>IMU获得的角速度为身体坐标系：</p>
<script type="math/tex; mode=display">
\begin{aligned}
\boldsymbol{\omega}_{s}&=\boldsymbol{R}_{z}(\psi)\boldsymbol{R}_{y}(\theta)\boldsymbol{R}_{x}(\phi)\boldsymbol{\omega}_{b}\\
\boldsymbol{\omega}_{b}&=\left[\boldsymbol{R}_{z}(\psi)\boldsymbol{R}_{y}(\theta)\boldsymbol{R}_{x}(\phi)\right]^{-1}\boldsymbol{\omega}_{s}\\
\left[\begin{matrix}{\dot{\phi}}\\{\dot{\theta}}\\{\dot{\psi}}\\\end{matrix}\right]&=\left[\begin{matrix}{\cos(\psi)/\cos(\theta)}&{\sin(\psi)/\cos(\theta)}&{0}\\{-\sin(\psi)}&{\cos(\psi)}&{0}\\{\cos(\psi)\tan(\theta)}&{\sin(\psi)\tan(\theta)}&{1}\\\end{matrix}\right]\boldsymbol{\omega}
\end{aligned}</script><p>在运动过程中机器人的pitch和row均接近于0，故可以忽略</p>
<script type="math/tex; mode=display">
\begin{aligned}
\begin{bmatrix}\dot{\phi}\\\dot{\theta}\\\dot{\psi}\end{bmatrix}&=\begin{bmatrix}\cos(\psi)&\sin(\psi)&0\\-\sin(\psi)&\cos(\psi)&0\\0&0&1\end{bmatrix}\boldsymbol{\omega}\\
&=\boldsymbol{R}_z^T(\psi)\boldsymbol{\omega}
\end{aligned}</script></li>
</ol>
<h3 id="状态方程"><a href="#状态方程" class="headerlink" title="状态方程"></a>状态方程</h3><p>下面写出状态方程：</p>
<ol>
<li><p>状态变量</p>
<p>位置 $\boldsymbol{p}=\begin{bmatrix}x\\y\\z\end{bmatrix}$ ，速度 $\dot{\boldsymbol{p}}=\begin{bmatrix}\dot{x}\\\dot{y}\\\dot{z}\end{bmatrix}$ ，姿态角 $\boldsymbol{\Theta}=\begin{bmatrix}\theta\\\phi\\\psi\end{bmatrix}$ ，姿态角速度 $\boldsymbol{\omega}=\begin{bmatrix}\dot{\theta}\\\dot{\phi}\\\dot{\psi}\end{bmatrix}$ ，重力加速度 $\boldsymbol{g}=\begin{bmatrix}{0}\\{0}\\{-9.8}\\\end{bmatrix}$ 。状态变量则为13维变量： $\boldsymbol{x}=\begin{bmatrix}\boldsymbol{\theta}\\\boldsymbol{p}\\\boldsymbol{w}\\\dot{\boldsymbol{p}}\\g(3)\end{bmatrix}$ 。</p>
</li>
<li><p>控制变量</p>
<p>控制变量为12维变量： $\boldsymbol{u}=\begin{bmatrix}\boldsymbol{f}_1\\\boldsymbol{f}_2\\\boldsymbol{f}_3\\\boldsymbol{f}_4\end{bmatrix}$ 。其中 $\boldsymbol{f}_i$ 为足底力。</p>
</li>
<li><p>状态方程</p>
<script type="math/tex; mode=display">
\begin{cases}\dot{\boldsymbol{x}}=\boldsymbol{A}\boldsymbol{x}+\boldsymbol{B}\boldsymbol{u}\\\boldsymbol{y}=\boldsymbol{C}\boldsymbol{x}+\boldsymbol{D}\boldsymbol{u}\end{cases}</script><p>将各个已知量带入：</p>
<script type="math/tex; mode=display">
\frac{d}{dt}\begin{bmatrix}\boldsymbol{\theta}\\\boldsymbol{p}\\\boldsymbol{\omega}\\\dot{\boldsymbol{p}}\\g(3)\end{bmatrix}=\begin{bmatrix}
\boldsymbol{0}_{3\times3}&\boldsymbol{0}_{3\times3}&\boldsymbol{R}_{z}^{T}(\psi)&\boldsymbol{0}_{3\times3}&\boldsymbol{0}_{3\times1}\\
\boldsymbol{0}_{3\times3}&\boldsymbol{0}_{3\times3}&\boldsymbol{0}_{3\times3}&\boldsymbol{I}_{3}&\boldsymbol{0}_{3\times1}\\
\boldsymbol{0}_{3\times3}&\boldsymbol{0}_{3\times3}&\boldsymbol{0}_{3\times3}&\boldsymbol{0}_{3\times3}&\boldsymbol{0}_{3\times1}\\
\boldsymbol{0}_{3\times3}&\boldsymbol{0}_{3\times3}&\boldsymbol{0}_{3\times3}&\boldsymbol{0}_{3\times3}&\left[\begin{smallmatrix}0\\0\\1\end{smallmatrix}\right]\\
\boldsymbol{0}_{1\times3}&\boldsymbol{0}_{1\times3}&\boldsymbol{0}_{1\times3}&\boldsymbol{0}_{1\times3}&1\end{bmatrix}\begin{bmatrix}\boldsymbol{\theta}\\\boldsymbol{p}\\\boldsymbol{\omega}\\\dot{\boldsymbol{p}}\\g(3)\end{bmatrix}+
\begin{bmatrix}\boldsymbol{0}_{3\times3}&\boldsymbol{0}_{3\times3}&\boldsymbol{0}_{3\times3}&\boldsymbol{0}_{3\times3}\\\boldsymbol{0}_{3\times3}&\boldsymbol{0}_{3\times3}&\boldsymbol{0}_{3\times3}&\boldsymbol{0}_{3\times3}\\\boldsymbol{I}^{-1}[\boldsymbol{r}_1]_\times&\boldsymbol{I}^{-1}[\boldsymbol{r}_2]_\times&\boldsymbol{I}^{-1}[\boldsymbol{r}_3]_\times&\boldsymbol{I}^{-1}[\boldsymbol{r}_4]_\times\\\boldsymbol{I}_3/m&\boldsymbol{I}_3/m&\boldsymbol{I}_3/m&\boldsymbol{I}_3/m\\\boldsymbol{0}_{1\times3}&\boldsymbol{0}_{1\times3}&\boldsymbol{0}_{1\times3}&\boldsymbol{0}_{1\times3}\end{bmatrix}\begin{bmatrix}\boldsymbol{f}_1\\\boldsymbol{f}_2\\\boldsymbol{f}_3\\\boldsymbol{f}_4\end{bmatrix}</script><p>要想写成代码，需要对其离散化。使用前向欧拉法离散化状态方程：</p>
<script type="math/tex; mode=display">
\begin{aligned}\dot{\boldsymbol{x}}&=\frac{\boldsymbol{x}_{k+1}-\boldsymbol{x}_k}{\Delta t}=\boldsymbol{A}\boldsymbol{x}_k+\boldsymbol{B}\boldsymbol{u}_k\\\boldsymbol{x}_{k+1}&=\underline{(\boldsymbol{I}+\Delta t\boldsymbol{A})}+\underline{\Delta t\boldsymbol{B}}u_k\\&=\overline{\boldsymbol{A}}\boldsymbol{x}_k+\overline{\boldsymbol{B}}\boldsymbol{u}_k\end{aligned}</script><p>其中的 $\overline{\boldsymbol{A}}$ 和 $\overline{\boldsymbol{B}}$ 表示为：</p>
<script type="math/tex; mode=display">
\begin{aligned}
\overline{\boldsymbol{A}}&=\begin{bmatrix}
\boldsymbol{I}_3&\boldsymbol{0}_{3\times3}&\boldsymbol{R}_{z}^{T}(d\psi^k)\Delta T&\boldsymbol{0}_{3\times3}&\boldsymbol{0}_{3\times1}\\
\boldsymbol{0}_{3\times3}&\boldsymbol{I}_3&\boldsymbol{0}_{3\times3}&\boldsymbol{I}_{3}\Delta T&\boldsymbol{0}_{3\times1}\\
\boldsymbol{0}_{3\times3}&\boldsymbol{0}_{3\times3}&\boldsymbol{I}_3&\boldsymbol{0}_{3\times3}&\boldsymbol{0}_{3\times1}\\
\boldsymbol{0}_{3\times3}&\boldsymbol{0}_{3\times3}&\boldsymbol{0}_{3\times3}&\boldsymbol{I}_3&\left[\begin{smallmatrix}0\\0\\1\end{smallmatrix}\right]\Delta T\\
\boldsymbol{0}_{1\times3}&\boldsymbol{0}_{1\times3}&\boldsymbol{0}_{1\times3}&\boldsymbol{0}_{1\times3}&1\end{bmatrix}\\
\overline{\boldsymbol{B}}&=\begin{bmatrix}\boldsymbol{0}_{3\times3}&\boldsymbol{0}_{3\times3}&\boldsymbol{0}_{3\times3}&\boldsymbol{0}_{3\times3}\\\boldsymbol{0}_{3\times3}&\boldsymbol{0}_{3\times3}&\boldsymbol{0}_{3\times3}&\boldsymbol{0}_{3\times3}\\\boldsymbol{I}_k^{-1}[\boldsymbol{r}_1^k]_\times\Delta T&\boldsymbol{I}_k^{-1}[\boldsymbol{r}_2^k]_\times\Delta T&\boldsymbol{I}_k^{-1}[\boldsymbol{r}_3^k]_\times\Delta T&\boldsymbol{I}_k^{-1}[\boldsymbol{r}_4^k]_\times\Delta T\\\boldsymbol{I}_3\Delta T/m&\boldsymbol{I}_3\Delta T/m&\boldsymbol{I}_3\Delta T/m&\boldsymbol{I}_3\Delta T/m\\\boldsymbol{0}_{1\times3}&\boldsymbol{0}_{1\times3}&\boldsymbol{0}_{1\times3}&\boldsymbol{0}_{1\times3}\end{bmatrix}
\end{aligned}</script></li>
</ol>
<h3 id="约束"><a href="#约束" class="headerlink" title="约束"></a>约束</h3><p>MPC最大的优势就是可以对输入量和状态变量进行约束，所以可以对输入进行约束。输入约束可以分为以下两个约束条件：</p>
<ol>
<li><p>足底反力</p>
<p>摆动时足底力为0，state=0， $\boldsymbol{f}_i=\boldsymbol{0}_{3\times1}$ </p>
<p>触地时最大足底力为 $f_{max}$ ，state=1， $f_i^z \le  f_{max}$ </p>
</li>
<li><p>摩擦锥</p>
<p>为保证足底与地面不滑动，足底反力的水平分量不能大于竖直分量 $\times \mu$ ，即</p>
<script type="math/tex; mode=display">
\begin{aligned}|f_i^x|&\le\mu f_i^z\\|f_i^y|&\le\mu f_i^z\\f_i^z&>0\end{aligned}</script></li>
</ol>
<p>结合以上两个约束，可以得到总的输入约束：</p>
<script type="math/tex; mode=display">
\begin{bmatrix}0\\0\\0\\0\\0\end{bmatrix}\leq\begin{bmatrix}-1&0&\mu\\0&-1&\mu\\1&0&\mu\\0&1&\mu\\0&0&1\end{bmatrix}\begin{bmatrix}{f_i}^x\\{f_i}^y\\{f_i}^z\end{bmatrix}\leq\begin{bmatrix}+\infty\\+\infty\\+\infty\\+\infty\\f_{\max}\end{bmatrix}</script><h3 id="优化问题"><a href="#优化问题" class="headerlink" title="优化问题"></a>优化问题</h3><p>首先建立代价函数（式中 $Q$ 、 $R$ 为对角正定/半正定矩阵，需要对其进行调参）</p>
<script type="math/tex; mode=display">
\min_{x,u}\sum_{i=0}^{K-1}\underset{误差加权和}{\underline{\|x_{i+1}-x_{i+i,ref}\|Q_{i}}}+\underset{输入加权和}{\underline{\|u_{i}\|R_{i}}}</script><p>使其满足：</p>
<script type="math/tex; mode=display">
\begin{cases}x_{i+1}=A_{i}x_{i}+B_{i}u_{i}&,i=0\cdots k-1\\\underline{c_{i}}\leq C_iu_i\leq\overline{c_{i}}&,i=0\cdots k-1(\text{支撑相})\\D_{i}u_{i}=0&,i=0\cdots k-1(\text{摆动相})&\end{cases}</script><p>对其进行二次规划，化为qpOASES标准形式：</p>
<script type="math/tex; mode=display">
\boxed{
\begin{aligned}
\min_{x}\quad&\frac12x^THx+x^Tg(w_0)\\s.t.\quad&lbA(\omega_0)\leq Ax\leq ubA(\omega_0)\\&lb(\omega_0)\leq x\leq ub(\omega_0)
\end{aligned}
}</script><p>预测步长为 $n$ ，状态量 $X_k=\begin{bmatrix}x_k^{k+1}\\x_k^{k+2}\\\vdots\\x_k^{k+n}\end{bmatrix}$ ，输入量 $U_{k}=\begin{bmatrix}u_{k}^{k}\\u_{k}^{k+1}\\\vdots\\u_{k}^{k+n-1}\end{bmatrix}$ ，则</p>
<script type="math/tex; mode=display">
X_{k}=\begin{bmatrix}\overline{A}\\\overline{A}^{2}\\\vdots\\\overline{A}^{N}\end{bmatrix}x_{k}+\begin{bmatrix}\overline{B}&0&\cdots&0\\\overline{A}\overline{B}&\overline{B}&\cdots&\vdots\\\vdots&\vdots&\ddots&\vdots\\\overline{A}^{N-1}\overline{B}&\overline{A}^{N-2}\overline{B}&\cdots&\overline{B}\end{bmatrix}U_{k}</script><p>上式可以记为 $X=A_{qp}x_0+B_{qp}U$ 。对于目标值 $X^{\mathrm{ref}}=\begin{bmatrix}x^{k+1}\\x^{k+2}\\\vdots\\x^{k+n}\end{bmatrix}$ ，优化问题可以转化为：</p>
<script type="math/tex; mode=display">
\begin{aligned}
\min_U\quad J(U)&=\| X-X^{\mathrm{ref}}\| L+\| U\| K\\
&=(X-X^{ref})^{T}L(X-X^{ref})+U^{T}KU\\
&=(A_{qp}x_0+B_{qp}U-y)^T L(A_{qp}x_0+B_{qp}U-y)+U^TKU\\
&=(x_0^TA^T_{qp}+U^TB_{qp}^T-y^T)L(A_{qp}x_0+B_{qp}U-y)+U^TkU\\
&=U^T(B^T_{qp}LB_{qp}+K)U+U^TB_{qp}^TL(A_{qp}x_0-y)+(A_{qp}x_0-y)^TLB_{qp}U+(A_{qp}x_0-y)^TL(A_{qp}x_0-y)\\
&=U^T(B_{qp}^TLB_{qp}+K)U+U^TB_{qp}^TL(A_{qp}x_0-y)+[U^TB_{qp}^TL(A_{qp}x_0-y)]^T+(A_{qp}x_0-y)^TL(A_{qp}x_0-y)
\end{aligned}</script><p>观察上式，第二第三项L左右均为向量且L为对角阵，故两者相同；第四项中的 $A_{qp}x_0-y$ 无控制量的影响，仅为状态量的变化，为常数项，可以省略。故上式可以整理为：</p>
<script type="math/tex; mode=display">
\begin{aligned}
\min_U\quad J(U)
&=U^T(B_{qp}^TLB_{qp}+K)U+2U^TB_{qp}^TL(A_{qp}x_0-y)
\end{aligned}</script><p>即可以整理为：</p>
<script type="math/tex; mode=display">
\begin{aligned}
\min_U \quad& \frac12U^THU+U^Tg\\
s.t. \quad& \underline{c}\leq CU\leq\overline{c}\end{aligned}</script><p>其中：（维度中的 $n$ 为足数4， $k$ 为单次MPC的迭代次数）</p>
<script type="math/tex; mode=display">
\begin{aligned}
H&=2(B_{qp}^TLB_{qp}+K)\in\mathbb{R}^{3nk\times3nk}\\
g&=2B_{qp}^TL(A_{qp}x_{0}-y)\in\mathbb{R}^{3nk\times1}\\
\end{aligned}</script><p>至此可得机器狗跟踪质心轨迹的一组最优足端支撑力， $u_0=\begin{bmatrix}f_1\\f_2\\f_3\\f_4\end{bmatrix}$ </p>
<h2 id="WBC控制器"><a href="#WBC控制器" class="headerlink" title="WBC控制器"></a>WBC控制器</h2><h3 id="计算关节位置、速度、加速度"><a href="#计算关节位置、速度、加速度" class="headerlink" title="计算关节位置、速度、加速度"></a>计算关节位置、速度、加速度</h3><h4 id="零空间"><a href="#零空间" class="headerlink" title="零空间"></a>零空间</h4><p>通过MPC可得到最优足端力 $\boldsymbol{u}_0$ ，可通过 $\boldsymbol{\tau}=\boldsymbol{J}(\boldsymbol{\theta})^T\boldsymbol{F}$ 计算关节力矩，但只适用于低速场景。在高速场景下，足端与地面的接触时间非常短，无法进行优化，此时动态性能较差，故需要使用WBC控制器，其输入参数为接触状态、支撑力、足端轨迹、质心轨迹。且其控制频率比MPC快。</p>
<p>当机器人高速运动时，四条腿触地时间很短，机器人大部分时间处于欠驱动状态，与无人机欠驱动系统不同，四足机器人与地面的频繁接触变成了干扰项。此时机器人相当于与一个虚拟浮动基座相连。此虚拟浮动基座有6个自由度（冗余），此时机器人的状态变得不确定。</p>
<p>将需要控制的变量进行优先级划分，使用零空间理论：</p>
<div class="table-container">
<table>
<thead>
<tr>
<th>级别</th>
<th>内容</th>
<th>约束</th>
</tr>
</thead>
<tbody>
<tr>
<td>0级</td>
<td>足端接触力</td>
<td>高级别</td>
</tr>
<tr>
<td>1级</td>
<td>机器人姿态</td>
<td>不能翻</td>
</tr>
<tr>
<td>2级</td>
<td>机器人位置</td>
<td>可适量浮动</td>
</tr>
<tr>
<td>3级</td>
<td>摆动退轨迹</td>
<td>低级别</td>
</tr>
</tbody>
</table>
</div>
<h5 id="冗余自由度机器人的优化"><a href="#冗余自由度机器人的优化" class="headerlink" title="冗余自由度机器人的优化"></a>冗余自由度机器人的优化</h5><p> $\boldsymbol{A}$ 的零空间是 $\boldsymbol{A}\boldsymbol{x}=\boldsymbol{0}$ 的所有解 $\boldsymbol{x}$ 的集合，也就是 $\boldsymbol{x}$ 固定，无论 $\boldsymbol{A}$ 取何值，结果均为0。类比串联机械臂，末端固定而其他关节转动时，所有能转动的位形构成零空间。</p>
<p>前文推导了末端速度与关节角速度之间的关系：$\dot{\boldsymbol{x}}=\boldsymbol{J}(\boldsymbol{\theta})\dot{\boldsymbol{\theta}}$ ，若 $\boldsymbol{J}(\boldsymbol{\theta})$ 可逆，可以得到 $\dot{\boldsymbol{\theta}}=\boldsymbol{J}^{-1}(\boldsymbol{\theta})\dot{\boldsymbol{x}}$ 。</p>
<p>若对于机械臂，遇到奇异位形，或关节数大于末端坐标数，此时 $\boldsymbol{J}(\boldsymbol{\theta})$ 不可逆。故引入伪逆， $\boldsymbol{J}(\boldsymbol{\theta})$ 的伪逆表示为 $\boldsymbol{J}^{\dagger}(\boldsymbol{\theta})$ ，无论 $\boldsymbol{J}(\boldsymbol{\theta})$ 是否可逆，关节角速度均可表示为 $\dot{\boldsymbol{\theta}}=\boldsymbol{J}^{\dagger}(\boldsymbol{\theta})\dot{\boldsymbol{x}}$ 。</p>
<p>伪逆的计算可以分两种情况</p>
<ol>
<li>欠约束，关节数n＜末端坐标数m， $\boldsymbol{J}^{\dagger}\boldsymbol{J}=\boldsymbol{I},\boldsymbol{J}^{\dagger}=(\boldsymbol{J}^{T}\boldsymbol{J})^{-1}$ ，此时方程可能无解，用代价函数使结果逼近设定值。</li>
<li>冗余约束，关节数n＞末端坐标数m， $\boldsymbol{J}\boldsymbol{J}^{\dagger}=\boldsymbol{I},\boldsymbol{J}^{\dagger}=\boldsymbol{J}^T(\boldsymbol{J}\boldsymbol{J}^{T})^{-1}$ ，此时方程有无数解，设定关节约束得到最优结果。</li>
</ol>
<p>对于冗余约束机械臂，若想在保持末端位姿不变的前提下控制其他关节的状态，则需利用零空间。</p>
<p> $\dot{\boldsymbol{\theta}}=\boldsymbol{J}^{\dagger}(\boldsymbol{\theta})\dot{\boldsymbol{x}}$ 是一个特解，其通解为 $\dot{\boldsymbol{\theta}}=\boldsymbol{J}^{\dagger}(\boldsymbol{\theta})\dot{\boldsymbol{x}}+(\boldsymbol{I-}\boldsymbol{J}^{\dagger}(\boldsymbol{\theta})\boldsymbol{J}(\boldsymbol{\theta}))\boldsymbol{z}$  TODO原理</p>
<p>将 $\dot{\boldsymbol{x}}$ 称为任务空间， $\dot{\boldsymbol{\theta}}$ 称为控制空间， $\boldsymbol{z}$ 称为零空间。 $\dot{\boldsymbol{x}}$ 中为高优先级的任务， $\boldsymbol{z}$ 中为低优先级的任务。</p>
<h5 id="两个任务"><a href="#两个任务" class="headerlink" title="两个任务"></a>两个任务</h5><p>对于两个任务，高优先级任务为 $\dot{\boldsymbol{w}}_1$ ，低优先级任务为 $\dot{\boldsymbol{w}}_2$ </p>
<script type="math/tex; mode=display">
\begin{aligned}
\dot{\boldsymbol{w}}_{1}=\boldsymbol{J}_1(\boldsymbol{\theta})\dot{\boldsymbol{\theta}}\\
\dot{\boldsymbol{w}}_{2}=\boldsymbol{J}_{2}(\boldsymbol{\theta})\dot{\boldsymbol{\theta}}\\
\end{aligned}</script><p>对于第一个高优先级任务的式子，其冗余控制方程为：</p>
<script type="math/tex; mode=display">
\dot{\boldsymbol{\theta}}=\boldsymbol{J}_{1}^{\dagger}(\boldsymbol{\theta})\dot{\boldsymbol{w}}_{1}+(\boldsymbol{I}-\boldsymbol{J}_{1}^{\dagger}(\boldsymbol{\theta})\boldsymbol{J}_{1}(\boldsymbol{\theta}))\boldsymbol{z}</script><p>将其带入第二个式子，得到：</p>
<script type="math/tex; mode=display">
\dot{\boldsymbol{w}}_{2}=\boldsymbol{J}_{2}(\boldsymbol{\theta})(\boldsymbol{J}_{1}^{\dagger}(\boldsymbol{\theta})\dot{\boldsymbol{w}}_{1}+(\boldsymbol{I}-\boldsymbol{J}_{1}^{\dagger}(\boldsymbol{\theta})\boldsymbol{J}_{1}(\boldsymbol{\theta}))\boldsymbol{z})</script><p>整理得：</p>
<script type="math/tex; mode=display">
\boldsymbol{J}_{2}(\boldsymbol{\theta})(\boldsymbol{I}-\boldsymbol{J}_{1}^{\dagger}(\boldsymbol{\theta})\boldsymbol{J}_{1}(\boldsymbol{\theta}))\boldsymbol{z}=\dot{\boldsymbol{w}}_{2}-\boldsymbol{J}_{2}(\boldsymbol{\theta})\boldsymbol{J}_{1}^{\dagger}(\boldsymbol{\theta})\dot{\boldsymbol{w}}_1</script><p>此时结果可能不唯一，使用最小二乘法优化代价函数。同样需要分为以下两种情况：</p>
<ol>
<li>欠约束， $\min |\boldsymbol{z}|_2$ </li>
<li>冗余约束， $\min |\boldsymbol{J}_{2}(\boldsymbol{\theta})(\boldsymbol{I}-\boldsymbol{J}_{1}^{\dagger}(\boldsymbol{\theta})\boldsymbol{J}_{1}(\boldsymbol{\theta}))\boldsymbol{z}-\dot{\boldsymbol{w}}_{2}+\boldsymbol{J}_{2}(\boldsymbol{\theta})\boldsymbol{J}_{1}^{\dagger}(\boldsymbol{\theta})\dot{\boldsymbol{w}}_1|_2$ </li>
</ol>
<h5 id="多个任务"><a href="#多个任务" class="headerlink" title="多个任务"></a>多个任务</h5><p>推广到一般形式，对于n个任务，符合任务优先级的关节速度为：</p>
<script type="math/tex; mode=display">
\begin{aligned}\dot{\boldsymbol{q}}&=\sum_{i=1}^{n}\boldsymbol{N}_{i}\dot{\boldsymbol{q}}_{i}\\
\dot{\boldsymbol{q}}_{i}&=(\boldsymbol{J}_{i}\overline{\boldsymbol{N}_{i}})^{\dagger}(\dot{\boldsymbol{x}}_{i}^{*}-\boldsymbol{J}_{i}\sum_{n=1}^{n-1}\boldsymbol{N}_{k}\dot{\boldsymbol{q}}_{k})\end{aligned}</script><p>式中 $\dot{\boldsymbol{x}}_{i}^{*}$ 为最优解， $\overline{\boldsymbol{N}_{i}}$ 为组合雅可比矩阵 $\overline{\boldsymbol{J}_{i}}$ 的零空间投影矩阵， $\overline{\boldsymbol{J}_i}=\begin{bmatrix}\boldsymbol{J}_1\\\boldsymbol{J}_2\\\vdots\\\boldsymbol{J}_{i-1}\end{bmatrix}$ 为所有任务优先级高于 $i$ 的任务的雅可比矩阵的组合。</p>
<p>写成迭代形式：</p>
<script type="math/tex; mode=display">
\dot{\boldsymbol{q}}_{i}=\dot{\boldsymbol{q}}_{i-1}+(\boldsymbol{J}_{i}\boldsymbol{N}_{i-1})^{\dagger}(\dot{\boldsymbol{x}}_{i}^{*}-\boldsymbol{J}_{i}\dot{\boldsymbol{q}}_{i-1})</script><h4 id="关节位置"><a href="#关节位置" class="headerlink" title="关节位置"></a>关节位置</h4><p>根据上文的推导，可以得到关节位置的迭代形式：</p>
<script type="math/tex; mode=display">
\begin{aligned}
\Delta\boldsymbol{q}_{1} &=\boldsymbol{J}_1^\dagger(\boldsymbol{x}_1^{des}-\boldsymbol{x}_1)\\
\Delta\boldsymbol{q}_{2} &=\Delta\boldsymbol{q}_1+\boldsymbol{J}_{2|pre}^\dagger(\boldsymbol{x}_2^\mathrm{des}-\boldsymbol{x}_2-\boldsymbol{J}_2\Delta\boldsymbol{q}_1)\\
&\vdots \\
\Delta\boldsymbol{q}_{i} &=\Delta\boldsymbol{q}_{i-1}+\boldsymbol{J}_{i|pre}^{\dagger}(\boldsymbol{x}_{i}^{\mathrm{des}}-\boldsymbol{x}_{i}-\boldsymbol{J}_{i}\Delta\boldsymbol{q}_{i-1})
\end{aligned}</script><p>其中：</p>
<script type="math/tex; mode=display">
\begin{aligned}
&\boldsymbol{J}_{i|pre}=\boldsymbol{J}_{i}\boldsymbol{N}_{i-1}, \\
&\boldsymbol{N}_{i-1}=\boldsymbol{N}_{0}\boldsymbol{N}_{1|0}\cdots\boldsymbol{N}_{i-1|i-2}, \\
&\boldsymbol{N}_{0}=\boldsymbol{I}-\boldsymbol{J}_{c}^{\dagger}\boldsymbol{J}_{c}, \\
&\boldsymbol{N}_{i|i-1}=\boldsymbol{I}-\boldsymbol{J}_{i|i-1}{}^{\dagger}\boldsymbol{J}_{i|i-1}.
\end{aligned}</script><p>其中 $\boldsymbol{J}_i$ 为第 $i$ 项任务雅可比矩阵； $\boldsymbol{x}_{i}^{\mathrm{des}}$ 为第 $i$ 项任务的期望位置； $\Delta\boldsymbol{q}_{i}$ 为根据第 $i$ 项任务迭代计算出的关节位置增量； $\boldsymbol{J}_{i|pre}$ 为第 $i$ 项任务到先前任务的零空间投影； $\boldsymbol{J}_c$ 为接触约束雅可比矩阵；</p>
<h4 id="关节速度与加速度"><a href="#关节速度与加速度" class="headerlink" title="关节速度与加速度"></a>关节速度与加速度</h4><p>同理可以得到关节速度与加速度（ $\text{dyn}$ 代表动态一致伪逆： $\overline{\boldsymbol{J}^{\mathrm{dyn}}}=\boldsymbol{A}^{-1}\boldsymbol{J}^T\left(\boldsymbol{J}\boldsymbol{A}^{-1}\boldsymbol{J}^T\right)^{-1}$ ）：</p>
<script type="math/tex; mode=display">
\begin{aligned}\dot{\boldsymbol{q}}_i^{\mathrm{cmd}}&=\dot{\boldsymbol{q}}_{i-1}^{\mathrm{cmd}}+\boldsymbol{J}_{i|pre}^{\dagger}\left(\dot{\boldsymbol{x}}_i^{\mathrm{des}}-\boldsymbol{J}_i\dot{\boldsymbol{q}}_{i-1}^{\mathrm{cmd}}\right),\\\ddot{\boldsymbol{q}}_i^{\mathrm{cmd}}&=\ddot{\boldsymbol{q}}_{i-1}^{\mathrm{cmd}}+\overline{\boldsymbol{J}_{i|pre}^{\mathrm{dyn}}}\left(\ddot{\boldsymbol{x}}_i^{\mathrm{cmd}}-\dot{\boldsymbol{J}}_i\dot{\boldsymbol{q}}-\boldsymbol{J}_i\ddot{\boldsymbol{q}}_{i-1}^{\mathrm{cmd}}\right)\end{aligned}</script><p>其中（ $\boldsymbol{K}_p$ 和 $\boldsymbol{K}_d$ 分别是位置和速度反馈增益，cmd代表控制命令）：</p>
<script type="math/tex; mode=display">
\begin{aligned}
\boldsymbol{q}_i^{\mathrm{cmd}}&=\boldsymbol{q}_i+\Delta\boldsymbol{q}_i\\
\ddot{\boldsymbol{x}}_i^\mathrm{cmd}&=\ddot{\boldsymbol{x}}^\mathrm{des}+\boldsymbol{K}_p\left(\boldsymbol{x}_i^\mathrm{des}-\boldsymbol{x}_i\right)+\boldsymbol{K}_d\left(\dot{\boldsymbol{x}}^\mathrm{des}-\dot{\boldsymbol{x}}\right)
\end{aligned}</script><p>计算出的 $\boldsymbol{q}_i^{\mathrm{cmd}}$ 和 $\dot{\boldsymbol{q}}_i^{\mathrm{cmd}}$ 发送到关节PD控制器、 $\ddot{\boldsymbol{q}}_i^{\mathrm{cmd}}$ 发送到QP规划器计算扭矩命令</p>
<h3 id="计算关节力矩"><a href="#计算关节力矩" class="headerlink" title="计算关节力矩"></a>计算关节力矩</h3><h4 id="浮动基动力学模型"><a href="#浮动基动力学模型" class="headerlink" title="浮动基动力学模型"></a>浮动基动力学模型</h4><p>对于固定机械臂这种基坐标系固定的机器人，只需知道每个关节的角度即可知道机器人的姿态。但对于四足机器人来说基座是不固定的，故需要在世界系与浮动基座机器人本体系之间建立一个没有实体的 6 自由度关节，其关节空间向量为 $\boldsymbol{q}={\begin{bmatrix}\boldsymbol{q}_f\\\boldsymbol{q}_j\end{bmatrix}}$ ，其中 $\boldsymbol{q}_f$ 代表身体浮动基的6个自由度， $\boldsymbol{q}_j$ 代表关节的12个自由度。浮动基动力学方程为：</p>
<script type="math/tex; mode=display">
\boldsymbol{A}\ddot{\boldsymbol{q}}+\boldsymbol{b}+\boldsymbol{g}=\boldsymbol{S}_j^T\boldsymbol{\tau}+\boldsymbol{J}_{int}^T\boldsymbol{f}_{int}-\boldsymbol{J}_c^T\boldsymbol{f}_i</script><p>上式中 $\boldsymbol{A}$ 为质量（惯量）矩阵； $\boldsymbol{b}$ 为可科氏力与离心力项； $\boldsymbol{g}$ 为重力项； $\boldsymbol{S}_j$ 为驱动关节选择矩阵，将驱动关节的扭矩映射到整个配置空间； $\boldsymbol{f}_{int}$ 为内力； $\boldsymbol{f}_i$ 为足底力； $\boldsymbol{J}$ 为约束雅可比矩阵，其中 $int$ 代表内部约束； $c$ 代表接触约束， $\boldsymbol{J}$ 满足下式：</p>
<script type="math/tex; mode=display">
\begin{aligned}
\boldsymbol{0}&=\boldsymbol{J}\dot{\boldsymbol{q}}
\\\boldsymbol{0}&=\boldsymbol{J}\ddot{\boldsymbol{q}}+\dot{\boldsymbol{J}}\dot{\boldsymbol{q}}
\end{aligned}</script><h4 id="松弛优化"><a href="#松弛优化" class="headerlink" title="松弛优化"></a>松弛优化</h4><p>在机器人的运动过程中需要遵循动力学方程以及满足一些不等式约束来保证机器人的稳定，故使用QP优化。引入松弛变量 $\boldsymbol{\delta}_{f_{r}}$ 、 $\boldsymbol{\delta}_{f}$ ，允许机器人基座与期望状态之间存在偏差，这使得机械狗在一些不可控制的姿态条件下，仍能计算出相应的控制信号，更有利于机器人的高速运动。</p>
<script type="math/tex; mode=display">
\begin{aligned}
\mathrm{min} \quad& \boldsymbol{\delta}_{f_r}^T\boldsymbol{Q}_1\boldsymbol{\delta}_{f_r}+\boldsymbol{\delta}_f^T\boldsymbol{Q}_2\boldsymbol{\delta}_f\\
\mathrm{s.t} \quad& \boldsymbol{S}_f (\boldsymbol{A}\ddot{\boldsymbol{q}}+\boldsymbol{b}+\boldsymbol{g})=\boldsymbol{S}_f \boldsymbol{J}_c^T\boldsymbol{f}_r\quad&\text{(浮动基动力学方程)}\\
&\ddot{\boldsymbol{q}}=\ddot{\boldsymbol{q}}^{\mathrm{cmd}}+\begin{bmatrix}\boldsymbol{\delta}_f\\\boldsymbol{o}_{nj}\end{bmatrix}\quad&\text{(加速度)}\\
&\boldsymbol{f}_r=\boldsymbol{f}_r^{\mathrm{MPC}}+\boldsymbol{\delta}_{f_r}\quad&\text{(足端接触反力)}\\
&\boldsymbol{W}\boldsymbol{f}_{r}\geq \boldsymbol{0} \quad&\text{(足端摩擦约束)}
\end{aligned}</script><p>其中， $\boldsymbol{f}_r^{\mathrm{MPC}}$ 为MPC计算的支撑腿的反作用力； $\boldsymbol{S}_f$ 为选择矩阵； $\boldsymbol{W}$ 为权重矩阵；</p>
<p>将优化出的地面反力、关节加速度及前文计算得到的关节位置、速度带到动力学方程里，可以求出支撑腿、摆动腿的关节力矩（对于摆动腿来说 $\boldsymbol{f}_r=0$ ）：</p>
<script type="math/tex; mode=display">
\begin{bmatrix}\boldsymbol{\tau}_f\\\boldsymbol{\tau}_j\end{bmatrix}=\boldsymbol{A}\ddot{\boldsymbol{q}}+\boldsymbol{b}+\boldsymbol{g}-\boldsymbol{J}_c\boldsymbol{f}_r</script><h3 id="向电机发送控制力矩"><a href="#向电机发送控制力矩" class="headerlink" title="向电机发送控制力矩"></a>向电机发送控制力矩</h3><p>之后使用求得的关节力矩做为前馈，再加上关节位置、速度的PD控制，对机器人的支撑腿、摆动腿进行控制。</p>
<script type="math/tex; mode=display">
\boldsymbol{\tau}_{i}=\boldsymbol{\tau}^\mathrm{cmd}+\boldsymbol{K}_{p}\left(\boldsymbol{q}_{i}^\mathrm{cmd}-\boldsymbol{q}_{i}\right)+\boldsymbol{K}_{d}\left(\dot{\boldsymbol{q}}_{i}^\mathrm{cmd}-\dot{\boldsymbol{q}}_{i}\right)</script><h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><h3 id="足式机器人"><a href="#足式机器人" class="headerlink" title="足式机器人"></a>足式机器人</h3><p><a target="_blank" rel="noopener" href="https://detail.tmall.com/item.htm?spm=a212k0.12153887.0.0.5487687dBgiovR&amp;id=704510718152">四足机器人控制算法—建模、控制与实践</a></p>
<p>基于稳定性的仿生四足机器人控制系统设计（于宪元）</p>
<p>Legged Robots That Balance</p>
<p>Quadrupedal Locomotion : An Introduction to the Control of Four-legged Robots</p>
<h3 id="状态估计器-1"><a href="#状态估计器-1" class="headerlink" title="状态估计器"></a>状态估计器</h3><p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/644393000">【干货|开源MIT Min cheetah机械狗设计(十)】|状态估计控制器设计</a></p>
<p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/pinking/p/9201405.html">卡尔曼滤波（kalman）相关理论以及与HMM、最小二乘法关系</a></p>
<h3 id="MPC部分"><a href="#MPC部分" class="headerlink" title="MPC部分"></a>MPC部分</h3><p>Dynamic Locomotion in the MIT Cheetah 3 Through Convex Model-Predictive Control</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/190044338">MIT四足机器人Cheetah 3控制方案理解笔记（2）——Convex Mpc身体姿态控制</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/640057159">【干货|开源MIT Min cheetah机械狗设计(七)】|MPC控制器之状态方程建立</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/640296839">【干货|开源MIT Min cheetah机械狗设计(八)】|MPC控制器设计</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/Kalenee/article/details/126440918">Cheetah-Software方案分析</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/268880700">四足机器人学习笔记（3）cheetah3 convexMPC论文学习笔记</a></p>
<h3 id="WBC部分"><a href="#WBC部分" class="headerlink" title="WBC部分"></a>WBC部分</h3><p>Highly Dynamic Quadruped Locomotion via Whole-Body Impulse Control and Model Predictive Control</p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/190049065">MIT四足机器人控制方案理解笔记（3）——Mini Cheetah 19年的MPC+WBC控制方案</a></p>
<p><a target="_blank" rel="noopener" href="https://zhuanlan.zhihu.com/p/641297823">【干货|开源MIT Min cheetah机械狗设计(九)】|WBC控制器设计</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/qq_46304090/article/details/126603897">机器人冗余自由度优化过程中的零空间概念</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/weixin_42235171/article/details/126447926">ETH机器人动力学讲义：基于零空间方法的全身运动控制（WBC）-1</a></p>
<h3 id="其他"><a href="#其他" class="headerlink" title="其他"></a>其他</h3><p>Computationally-Robust and Efficient Prioritized Whole-Body Controller with Contact Constraints</p>
<h3 id="机器人学相关书籍"><a href="#机器人学相关书籍" class="headerlink" title="机器人学相关书籍"></a>机器人学相关书籍</h3><p>Robot Modeling and Control（机器人建模和控制）</p>
<p>Robotics, Vision and Control Fundamental Algorithms In MATLAB（机器人学 机器视觉与控制 MATLAB算法基础）</p>
<p>Introduction to Robotics Mechanics and Control（机器人学导论）</p>
<p>Modern Robotic Mechanics, Planning, and Control（现代机器人学：机构、规划与控制）</p>
<p>Control of Robot Manipulators in Joint Space</p>
<p>Rigid-Body Dynamics Algorithms</p>
<p>Springer Handbook of Robotics（机器人手册）</p>
<p>Theory of applied robotics: kinematics, dynamics, and control.（应用机器人学：运动学、动力学与控制技术）</p>
<p>Robot Dynamics Lecture Notes（机器人动力学课程笔记）</p>
</article><div class="post-copyright"><div class="post-copyright__author"><span class="post-copyright-meta">文章作者: </span><span class="post-copyright-info"><a href="https://www.robotsfan.com">Fan Ziqi</a></span></div><div class="post-copyright__type"><span class="post-copyright-meta">文章链接: </span><span class="post-copyright-info"><a href="https://www.robotsfan.com/posts/311d50f4.html">https://www.robotsfan.com/posts/311d50f4.html</a></span></div><div class="post-copyright__notice"><span class="post-copyright-meta">版权声明: </span><span class="post-copyright-info">本博客所有文章除特别声明外，均采用 <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" target="_blank">CC BY-NC-SA 4.0</a> 许可协议。转载请注明来自 <a href="https://www.robotsfan.com" target="_blank">范子琦的博客</a>！</span></div></div><div class="tag_share"><div class="post-meta__tag-list"><a class="post-meta__tags" href="/tags/%E6%9C%BA%E5%99%A8%E4%BA%BA/">机器人</a></div><div class="post_share"><div class="social-share" data-image="https://fan-ziqi.oss-cn-beijing.aliyuncs.com/img/blog-cover3.jpg" data-sites="facebook,twitter,wechat,weibo,qq"></div><link rel="stylesheet" href="https://unpkg.com/butterfly-extsrc/sharejs/dist/css/share.min.css" media="print" onload="this.media='all'"><script src="https://unpkg.com/butterfly-extsrc/sharejs/dist/js/social-share.min.js" defer></script></div></div><div class="post-reward"><div class="reward-button"><i class="fas fa-qrcode"></i> 打赏</div><div class="reward-main"><ul class="reward-all"><li class="reward-item"><a href="https://fan-ziqi.oss-cn-beijing.aliyuncs.com/img/blog-wechat.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://fan-ziqi.oss-cn-beijing.aliyuncs.com/img/blog-wechat.jpg" alt="微信"/></a><div class="post-qr-code-desc">微信</div></li><li class="reward-item"><a href="https://fan-ziqi.oss-cn-beijing.aliyuncs.com/img/blog-alipay.jpg" target="_blank"><img class="post-qr-code-img" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://fan-ziqi.oss-cn-beijing.aliyuncs.com/img/blog-alipay.jpg" alt="支付宝"/></a><div class="post-qr-code-desc">支付宝</div></li></ul></div></div><nav class="pagination-post" id="pagination"><div class="prev-post pull-full"><a href="/posts/ffad622d.html" title="ETH机器人学生奖学金"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://fan-ziqi.oss-cn-beijing.aliyuncs.com/img/blog-cover2.jpg" onerror="onerror=null;src='https://fan-ziqi.oss-cn-beijing.aliyuncs.com/img/blog-404.jpg'" alt="cover of previous post"><div class="pagination-info"><div class="label">上一篇</div><div class="prev_info">ETH机器人学生奖学金</div></div></a></div></nav><div class="relatedPosts"><div class="headline"><i class="fas fa-thumbs-up fa-fw"></i><span>相关推荐</span></div><div class="relatedPosts-list"><div><a href="/posts/c0ff5b54.html" title="机器人动力学——拉格朗日法"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://fan-ziqi.oss-cn-beijing.aliyuncs.com/img/blog-cover4.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2022-03-15</div><div class="title">机器人动力学——拉格朗日法</div></div></a></div><div><a href="/posts/ffad622d.html" title="ETH机器人学生奖学金"><img class="cover" src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://fan-ziqi.oss-cn-beijing.aliyuncs.com/img/blog-cover2.jpg" alt="cover"><div class="content is-center"><div class="date"><i class="far fa-calendar-alt fa-fw"></i> 2024-02-01</div><div class="title">ETH机器人学生奖学金</div></div></a></div></div></div><hr class="custom-hr"/><div id="post-comment"><div class="comment-head"><div class="comment-headline"><i class="fas fa-comments fa-fw"></i><span> 评论</span></div></div><div class="comment-wrap"><div><div class="vcomment" id="vcomment"></div></div></div></div></div><div class="aside-content" id="aside-content"><div class="sticky_layout"><div class="card-widget" id="card-toc"><div class="item-headline"><i class="fas fa-stream"></i><span>目录</span><span class="toc-percentage"></span></div><div class="toc-content"><ol class="toc"><li class="toc-item toc-level-1"><a class="toc-link" href="#%E5%9B%9B%E8%B6%B3%E6%9C%BA%E5%99%A8%E4%BA%BA%E4%BC%A0%E7%BB%9F%E6%8E%A7%E5%88%B6%E6%96%B9%E6%B3%95%E5%AD%A6%E4%B9%A0%E7%AC%94%E8%AE%B0"><span class="toc-number">1.</span> <span class="toc-text">四足机器人传统控制方法学习笔记</span></a><ol class="toc-child"><li class="toc-item toc-level-2"><a class="toc-link" href="#%E8%BF%90%E5%8A%A8%E5%AD%A6%E4%B8%8E%E5%8A%A8%E5%8A%9B%E5%AD%A6"><span class="toc-number">1.1.</span> <span class="toc-text">运动学与动力学</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E8%85%BF%E8%BF%90%E5%8A%A8%E5%AD%A6"><span class="toc-number">1.1.1.</span> <span class="toc-text">单腿运动学</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%AD%A3%E8%BF%90%E5%8A%A8%E5%AD%A6"><span class="toc-number">1.1.1.1.</span> <span class="toc-text">正运动学</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%86%E8%BF%90%E5%8A%A8%E5%AD%A6"><span class="toc-number">1.1.1.2.</span> <span class="toc-text">逆运动学</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%85%E5%8F%AF%E6%AF%94%E7%9F%A9%E9%98%B5"><span class="toc-number">1.1.1.3.</span> <span class="toc-text">雅可比矩阵</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%8D%95%E8%85%BF%E9%9D%99%E5%8A%9B%E5%AD%A6"><span class="toc-number">1.1.2.</span> <span class="toc-text">单腿静力学</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E8%B6%B3%E8%BF%90%E5%8A%A8%E5%AD%A6"><span class="toc-number">1.1.3.</span> <span class="toc-text">四足运动学</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%94%B9%E5%8F%98%E5%A7%BF%E6%80%81"><span class="toc-number">1.1.3.1.</span> <span class="toc-text">改变姿态</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%B6%B3%E7%AB%AF%E9%80%9F%E5%BA%A6"><span class="toc-number">1.1.3.2.</span> <span class="toc-text">足端速度</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%9B%9B%E8%B6%B3%E5%8A%A8%E5%8A%9B%E5%AD%A6"><span class="toc-number">1.1.4.</span> <span class="toc-text">四足动力学</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E5%88%9A%E4%BD%93%E5%8A%A8%E5%8A%9B%E5%AD%A6"><span class="toc-number">1.1.4.1.</span> <span class="toc-text">单刚体动力学</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8D%95%E5%88%9A%E4%BD%93%E5%8A%A8%E8%83%BD"><span class="toc-number">1.1.4.2.</span> <span class="toc-text">单刚体动能</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%9B%9B%E8%B6%B3%E5%8A%A8%E5%8A%9B%E5%AD%A6-1"><span class="toc-number">1.1.4.3.</span> <span class="toc-text">四足动力学</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E4%BC%B0%E8%AE%A1%E5%99%A8"><span class="toc-number">1.2.</span> <span class="toc-text">状态估计器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E5%B0%8F%E4%BA%8C%E4%B9%98%E4%B8%8E%E5%8D%A1%E5%B0%94%E6%9B%BC%E6%BB%A4%E6%B3%A2"><span class="toc-number">1.2.1.</span> <span class="toc-text">最小二乘与卡尔曼滤波</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BD%BF%E7%94%A8IMU%E8%8E%B7%E5%BE%97%E5%A7%BF%E6%80%81"><span class="toc-number">1.2.2.</span> <span class="toc-text">使用IMU获得姿态</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E7%A9%BA%E9%97%B4%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.2.3.</span> <span class="toc-text">状态空间模型</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9E%E7%BB%AD%E7%8A%B6%E6%80%81%E7%A9%BA%E9%97%B4%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.2.3.1.</span> <span class="toc-text">连续状态空间模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%A6%BB%E6%95%A3%E7%8A%B6%E6%80%81%E7%A9%BA%E9%97%B4%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.2.3.2.</span> <span class="toc-text">离散状态空间模型</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%80%E5%B0%8F%E4%BA%8C%E4%B9%98%E4%BC%B0%E8%AE%A1"><span class="toc-number">1.2.4.</span> <span class="toc-text">最小二乘估计</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%8A%A0%E6%9D%83%E6%9C%80%E5%B0%8F%E4%BA%8C%E4%B9%98%E4%BC%B0%E8%AE%A1"><span class="toc-number">1.2.4.1.</span> <span class="toc-text">加权最小二乘估计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%80%92%E6%8E%A8%E6%9C%80%E5%B0%8F%E4%BA%8C%E4%B9%98%E4%BC%B0%E8%AE%A1"><span class="toc-number">1.2.4.2.</span> <span class="toc-text">递推最小二乘估计</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9C%80%E5%B0%8F%E4%BA%8C%E4%B9%98%E4%BC%B0%E8%AE%A1%E6%B5%81%E7%A8%8B%E6%80%BB%E7%BB%93"><span class="toc-number">1.2.4.3.</span> <span class="toc-text">最小二乘估计流程总结</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%87%E7%A8%8B%E5%99%AA%E5%A3%B0"><span class="toc-number">1.2.4.4.</span> <span class="toc-text">过程噪声</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%89%A9%E5%B1%95%E5%8D%A1%E5%B0%94%E6%9B%BC%E6%BB%A4%E6%B3%A2%E5%99%A8"><span class="toc-number">1.2.5.</span> <span class="toc-text">扩展卡尔曼滤波器</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E6%AD%A5%E6%80%81%E8%BD%A8%E8%BF%B9%E8%A7%84%E5%88%92"><span class="toc-number">1.3.</span> <span class="toc-text">步态轨迹规划</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%90%BD%E8%84%9A%E7%82%B9%E7%9A%84%E9%80%89%E5%8F%96"><span class="toc-number">1.3.1.</span> <span class="toc-text">落脚点的选取</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%B9%B3%E7%A7%BB"><span class="toc-number">1.3.1.1.</span> <span class="toc-text">平移</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%97%8B%E8%BD%AC"><span class="toc-number">1.3.1.2.</span> <span class="toc-text">旋转</span></a></li></ol></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#MPC%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number">1.4.</span> <span class="toc-text">MPC控制器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%9B%AE%E6%A0%87"><span class="toc-number">1.4.1.</span> <span class="toc-text">目标</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%AE%80%E5%8C%96%E5%8D%95%E5%88%9A%E4%BD%93%E5%8A%A8%E5%8A%9B%E5%AD%A6"><span class="toc-number">1.4.2.</span> <span class="toc-text">简化单刚体动力学</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E6%96%B9%E7%A8%8B"><span class="toc-number">1.4.3.</span> <span class="toc-text">状态方程</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%BA%A6%E6%9D%9F"><span class="toc-number">1.4.4.</span> <span class="toc-text">约束</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E4%BC%98%E5%8C%96%E9%97%AE%E9%A2%98"><span class="toc-number">1.4.5.</span> <span class="toc-text">优化问题</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#WBC%E6%8E%A7%E5%88%B6%E5%99%A8"><span class="toc-number">1.5.</span> <span class="toc-text">WBC控制器</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E5%85%B3%E8%8A%82%E4%BD%8D%E7%BD%AE%E3%80%81%E9%80%9F%E5%BA%A6%E3%80%81%E5%8A%A0%E9%80%9F%E5%BA%A6"><span class="toc-number">1.5.1.</span> <span class="toc-text">计算关节位置、速度、加速度</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%9B%B6%E7%A9%BA%E9%97%B4"><span class="toc-number">1.5.1.1.</span> <span class="toc-text">零空间</span></a><ol class="toc-child"><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%86%97%E4%BD%99%E8%87%AA%E7%94%B1%E5%BA%A6%E6%9C%BA%E5%99%A8%E4%BA%BA%E7%9A%84%E4%BC%98%E5%8C%96"><span class="toc-number">1.5.1.1.1.</span> <span class="toc-text">冗余自由度机器人的优化</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E4%B8%A4%E4%B8%AA%E4%BB%BB%E5%8A%A1"><span class="toc-number">1.5.1.1.2.</span> <span class="toc-text">两个任务</span></a></li><li class="toc-item toc-level-5"><a class="toc-link" href="#%E5%A4%9A%E4%B8%AA%E4%BB%BB%E5%8A%A1"><span class="toc-number">1.5.1.1.3.</span> <span class="toc-text">多个任务</span></a></li></ol></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E8%8A%82%E4%BD%8D%E7%BD%AE"><span class="toc-number">1.5.1.2.</span> <span class="toc-text">关节位置</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E5%85%B3%E8%8A%82%E9%80%9F%E5%BA%A6%E4%B8%8E%E5%8A%A0%E9%80%9F%E5%BA%A6"><span class="toc-number">1.5.1.3.</span> <span class="toc-text">关节速度与加速度</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%AE%A1%E7%AE%97%E5%85%B3%E8%8A%82%E5%8A%9B%E7%9F%A9"><span class="toc-number">1.5.2.</span> <span class="toc-text">计算关节力矩</span></a><ol class="toc-child"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%B5%AE%E5%8A%A8%E5%9F%BA%E5%8A%A8%E5%8A%9B%E5%AD%A6%E6%A8%A1%E5%9E%8B"><span class="toc-number">1.5.2.1.</span> <span class="toc-text">浮动基动力学模型</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E6%9D%BE%E5%BC%9B%E4%BC%98%E5%8C%96"><span class="toc-number">1.5.2.2.</span> <span class="toc-text">松弛优化</span></a></li></ol></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%90%91%E7%94%B5%E6%9C%BA%E5%8F%91%E9%80%81%E6%8E%A7%E5%88%B6%E5%8A%9B%E7%9F%A9"><span class="toc-number">1.5.3.</span> <span class="toc-text">向电机发送控制力矩</span></a></li></ol></li><li class="toc-item toc-level-2"><a class="toc-link" href="#%E5%8F%82%E8%80%83%E6%96%87%E7%8C%AE"><span class="toc-number">1.6.</span> <span class="toc-text">参考文献</span></a><ol class="toc-child"><li class="toc-item toc-level-3"><a class="toc-link" href="#%E8%B6%B3%E5%BC%8F%E6%9C%BA%E5%99%A8%E4%BA%BA"><span class="toc-number">1.6.1.</span> <span class="toc-text">足式机器人</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E7%8A%B6%E6%80%81%E4%BC%B0%E8%AE%A1%E5%99%A8-1"><span class="toc-number">1.6.2.</span> <span class="toc-text">状态估计器</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#MPC%E9%83%A8%E5%88%86"><span class="toc-number">1.6.3.</span> <span class="toc-text">MPC部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#WBC%E9%83%A8%E5%88%86"><span class="toc-number">1.6.4.</span> <span class="toc-text">WBC部分</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E5%85%B6%E4%BB%96"><span class="toc-number">1.6.5.</span> <span class="toc-text">其他</span></a></li><li class="toc-item toc-level-3"><a class="toc-link" href="#%E6%9C%BA%E5%99%A8%E4%BA%BA%E5%AD%A6%E7%9B%B8%E5%85%B3%E4%B9%A6%E7%B1%8D"><span class="toc-number">1.6.6.</span> <span class="toc-text">机器人学相关书籍</span></a></li></ol></li></ol></li></ol></div></div></div></div></main><footer id="footer" style="background-image: url('https://fan-ziqi.oss-cn-beijing.aliyuncs.com/img/blog-cover3.jpg')"><div id="footer-wrap"><div class="copyright">&copy;2020 - 2024 By Fan Ziqi</div><div class="framework-info"><span>框架 </span><a target="_blank" rel="noopener" href="https://hexo.io">Hexo</a><span class="footer-separator">|</span><span>主题 </span><a target="_blank" rel="noopener" href="https://github.com/jerryc127/hexo-theme-butterfly">Butterfly</a><br>
<img src= "data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-lazy-src="https://fan-ziqi.oss-cn-beijing.aliyuncs.com/img/icp.png">
<a href="https://beian.miit.gov.cn/#/Integrated/index"  style="color:white" target="_blank">辽ICP备2021010164号-3</a></div><div class="footer_custom_text">Hi, welcome to my <a href="https://www.robotsfan.com/">blog</a>!</div></div></footer></div><div id="rightside"><div id="rightside-config-hide"><button id="readmode" type="button" title="阅读模式"><i class="fas fa-book-open"></i></button><button id="translateLink" type="button" title="简繁转换">繁</button><button id="darkmode" type="button" title="浅色和深色模式转换"><i class="fas fa-adjust"></i></button><button id="hide-aside-btn" type="button" title="单栏和双栏切换"><i class="fas fa-arrows-alt-h"></i></button></div><div id="rightside-config-show"><button id="rightside_config" type="button" title="设置"><i class="fas fa-cog fa-spin"></i></button><button class="close" id="mobile-toc-button" type="button" title="目录"><i class="fas fa-list-ul"></i></button><a id="to_comment" href="#post-comment" title="直达评论"><i class="fas fa-comments"></i></a><button id="go-up" type="button" title="回到顶部"><span class="scroll-percent"></span><i class="fas fa-arrow-up"></i></button></div></div><div><script src="https://unpkg.com/hexo-theme-butterfly/source/js/utils.js"></script><script src="https://unpkg.com/hexo-theme-butterfly/source/js/main.js"></script><script src="https://unpkg.com/hexo-theme-butterfly/source/js/tw_cn.js"></script><script src="https://unpkg.com/@fancyapps/ui/dist/fancybox/fancybox.umd.js"></script><script src="https://unpkg.com/instant.page/instantpage.js" type="module"></script><script src="https://unpkg.com/vanilla-lazyload/dist/lazyload.iife.min.js"></script><script src="https://unpkg.com/node-snackbar/dist/snackbar.min.js"></script><div class="js-pjax"><script>if (!window.MathJax) {
  window.MathJax = {
    tex: {
      inlineMath: [['$', '$'], ['\\(', '\\)']],
      tags: 'ams'
    },
    chtml: {
      scale: 1.1
    },
    options: {
      renderActions: {
        findScript: [10, doc => {
          for (const node of document.querySelectorAll('script[type^="math/tex"]')) {
            const display = !!node.type.match(/; *mode=display/)
            const math = new doc.options.MathItem(node.textContent, doc.inputJax[0], display)
            const text = document.createTextNode('')
            node.parentNode.replaceChild(text, node)
            math.start = {node: text, delim: '', n: 0}
            math.end = {node: text, delim: '', n: 0}
            doc.math.push(math)
          }
        }, '']
      }
    }
  }
  
  const script = document.createElement('script')
  script.src = 'https://unpkg.com/mathjax/es5/tex-mml-chtml.js'
  script.id = 'MathJax-script'
  script.async = true
  document.head.appendChild(script)
} else {
  MathJax.startup.document.state(0)
  MathJax.texReset()
  MathJax.typesetPromise()
}</script><script>function loadValine () {
  function initValine () {
    const valine = new Valine(Object.assign({
      el: '#vcomment',
      appId: 'OjsFbKXQ3IMTb9HbvzYfYmcx-gzGzoHsz',
      appKey: 'VBrjucYOiSf9CLiztjFtt7Oc',
      avatar: 'monsterid',
      serverURLs: '',
      emojiMaps: "",
      path: window.location.pathname,
      visitor: false
    }, null))
  }

  if (typeof Valine === 'function') initValine() 
  else getScript('https://unpkg.com/valine/dist/Valine.min.js').then(initValine)
}

if ('Valine' === 'Valine' || !false) {
  if (false) btf.loadComment(document.getElementById('vcomment'),loadValine)
  else setTimeout(loadValine, 0)
} else {
  function loadOtherComment () {
    loadValine()
  }
}</script></div><link rel="stylesheet" href="https://unpkg.com/aplayer/dist/APlayer.min.css" media="print" onload="this.media='all'"><script src="https://unpkg.com/aplayer/dist/APlayer.min.js"></script><script src="https://unpkg.com/butterfly-extsrc/metingjs/dist/Meting.min.js"></script><script async data-pjax src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><div id="local-search"><div class="search-dialog"><nav class="search-nav"><span class="search-dialog-title">搜索</span><span id="loading-status"></span><button class="search-close-button"><i class="fas fa-times"></i></button></nav><div class="is-center" id="loading-database"><i class="fas fa-spinner fa-pulse"></i><span>  数据库加载中</span></div><div class="search-wrap"><div id="local-search-input"><div class="local-search-box"><input class="local-search-box--input" placeholder="搜索文章" type="text"/></div></div><hr/><div class="no-result" id="local-search-results"></div><div id="local-search-stats-wrap"></div></div></div><div id="search-mask"></div><script src="https://unpkg.com/hexo-theme-butterfly/source/js/search/local-search.js"></script></div></div><!-- hexo injector body_end start --> <script data-pjax>if(document.getElementById('recent-posts') && (location.pathname ==='all'|| 'all' ==='all')){
    var parent = document.getElementById('recent-posts');
    var child = '<div class="recent-post-item" style="width:100%;height: auto"><div id="catalog_magnet"><div class="magnet_item"><a class="magnet_link" href="https://www.robotsfan.com/categories/C/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">💻 C++学习 (12)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://www.robotsfan.com/categories/ROS1学习/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🤖 ROS1学习 (2)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://www.robotsfan.com/categories/ROS2学习/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🤖 ROS1学习 (5)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://www.robotsfan.com/categories/算法/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">👩‍💻 算法 (4)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://www.robotsfan.com/categories/电机/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">🧲 电机 (3)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><div class="magnet_item"><a class="magnet_link" href="https://www.robotsfan.com/categories/stm32/"><div class="magnet_link_context" style=""><span style="font-weight:500;flex:1">💡 stm32 (7)</span><span style="padding:0px 4px;border-radius: 8px;"><i class="fas fa-arrow-circle-right"></i></span></div></a></div><a class="magnet_link_more"  href="https://www.robotsfan.com/categories" style="flex:1;text-align: center;margin-bottom: 10px;">查看更多...</a></div></div>';
    console.log('已挂载magnet')
    parent.insertAdjacentHTML("afterbegin",child)}
     </script><style>#catalog_magnet{flex-wrap: wrap;display: flex;width:100%;justify-content:space-between;padding: 10px 10px 0 10px;align-content: flex-start;}.magnet_item{flex-basis: calc(50% - 5px);background: #f2f2f2;margin-bottom: 10px;border-radius: 8px;transition: all 0.2s ease-in-out;}.magnet_item:hover{background: #6699ff}.magnet_link_more{color:#555}.magnet_link{color:black}.magnet_link:hover{color:white}@media screen and (max-width: 600px) {.magnet_item {flex-basis: 100%;}}.magnet_link_context{display:flex;padding: 10px;font-size:16px;transition: all 0.2s ease-in-out;}.magnet_link_context:hover{padding: 10px 20px;}</style>
    <style></style><!-- hexo injector body_end end --></body></html>